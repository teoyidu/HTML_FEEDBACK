<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AI Chatbot Feedback System</title>
  <style>
    /* General styles */
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
      background-color: #111827;
      color: #f3f4f6;
      line-height: 1.5;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 1.5rem;
    }

    h1 {
      font-size: 1.5rem;
      font-weight: bold;
      margin-bottom: 1.5rem;
    }

    /* Search bar */
    .search-container {
      position: relative;
      margin-bottom: 1.5rem;
    }

    .search-icon {
      position: absolute;
      left: 0.75rem;
      top: 50%;
      transform: translateY(-50%);
      color: #9ca3af;
    }

    .search-input {
      width: 100%;
      padding: 0.625rem 0.75rem 0.625rem 2.5rem;
      background-color: #1f2937;
      border: 1px solid #374151;
      border-radius: 0.5rem;
      color: #f3f4f6;
      font-size: 0.875rem;
    }

    .search-input:focus {
      outline: none;
      border-color: #3b82f6;
      box-shadow: 0 0 0 1px #3b82f6;
    }

    /* Filter styles */
    .filter-section {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      margin-bottom: 1.5rem;
    }

    .filter-label {
      display: flex;
      align-items: center;
      margin-right: 0.5rem;
    }

    .filter-label svg {
      margin-right: 0.25rem;
    }

    .filter-buttons {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
    }

    .filter-btn {
      padding: 0.25rem 0.75rem;
      border-radius: 9999px;
      font-size: 0.875rem;
      background-color: #1f2937;
      color: #d1d5db;
      border: none;
      cursor: pointer;
      transition: background-color 0.2s;
      display: flex;
      align-items: center;
      gap: 0.25rem;
    }

    .filter-btn:hover {
      background-color: #374151;
    }

    .filter-btn.active {
      background-color: #2563eb;
      color: white;
    }

    .filter-btn svg {
      width: 0.875rem;
      height: 0.875rem;
    }

    .filter-btn.active svg {
      color: white;
    }

    .filter-btn.positive.active {
      background-color: #059669;
    }

    .filter-btn.negative.active {
      background-color: #dc2626;
    }

    .filter-btn.hidden.active {
      background-color: #7c3aed;
    }

    .feedback-filters {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      margin-bottom: 1.5rem;
      border-top: 1px solid #374151;
      padding-top: 1rem;
    }

    /* Page size buttons */
    .page-size {
      display: flex;
      gap: 0.5rem;
      margin-bottom: 1.5rem;
      align-items: center;
    }

    .page-size-btn {
      padding: 0.25rem 0.75rem;
      border-radius: 0.25rem;
      font-size: 0.875rem;
      background-color: #1f2937;
      color: #d1d5db;
      border: none;
      cursor: pointer;
    }

    .page-size-btn.active {
      background-color: #374151;
      color: white;
    }

    /* Results count */
    .results-count {
      margin-bottom: 1rem;
      color: #9ca3af;
      font-size: 0.875rem;
    }

    /* Feedback items */
    .feedback-items {
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }

    .feedback-item {
      padding: 1rem;
      border-radius: 0.5rem;
      background-color: #1f2937;
      cursor: pointer;
      transition: background-color 0.2s;
      position: relative;
    }

    .feedback-item:hover {
      background-color: #212938;
    }

    .feedback-item.hidden {
      background-color: #111827;
      border: 1px solid #374151;
    }

    .feedback-item.positive {
      border-left: 4px solid #10b981;
    }

    .feedback-item.negative {
      border-left: 4px solid #ef4444;
    }

    .feedback-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
    }

    .feedback-content {
      flex-grow: 1;
    }

    .feedback-tags {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      margin-bottom: 0.25rem;
    }

    .tag {
      background-color: #374151;
      color: #d1d5db;
      font-size: 0.75rem;
      font-weight: 500;
      padding: 0.125rem 0.625rem;
      border-radius: 0.25rem;
      display: inline-flex;
      align-items: center;
    }

    .tag.positive {
      background-color: #065f46;
      color: #a7f3d0;
    }

    .tag.negative {
      background-color: #7f1d1d;
      color: #fca5a5;
    }

    .tag.archived {
      background-color: #5b21b6;
      color: #ddd6fe;
    }

    .tag svg {
      width: 0.75rem;
      height: 0.75rem;
      margin-right: 0.25rem;
    }

    .feedback-question {
      font-size: 1.125rem;
      font-weight: 500;
      margin-top: 0.25rem;
    }

    .feedback-query {
      color: #9ca3af;
      font-size: 0.875rem;
      margin-top: 0.25rem;
    }

    .feedback-meta {
      margin-top: 0.5rem;
      display: flex;
      align-items: center;
      font-size: 0.75rem;
      color: #6b7280;
    }

    .feedback-meta svg {
      width: 0.75rem;
      height: 0.75rem;
      margin-right: 0.25rem;
    }

    .feedback-actions {
      display: flex;
      gap: 0.5rem;
    }

    .action-btn {
      padding: 0.375rem;
      border-radius: 9999px;
      background-color: transparent;
      border: none;
      cursor: pointer;
      transition: background-color 0.2s;
    }

    .action-btn:hover {
      background-color: #374151;
    }

    .action-btn.positive {
      color: #10b981;
    }

    .action-btn.positive.active {
      background-color: rgba(16, 185, 129, 0.2);
    }

    .action-btn.negative {
      color: #ef4444;
    }

    .action-btn.negative.active {
      background-color: rgba(239, 68, 68, 0.2);
    }

    .action-btn.hidden {
      color: #9ca3af;
      position: relative;
    }

    .action-btn.hidden.active {
      background-color: rgba(124, 58, 237, 0.2);
    }

    /* Add archive button styling */
    .action-btn.archive {
      color: #9ca3af;
      position: relative;
    }

    .action-btn.archive.active {
      background-color: rgba(124, 58, 237, 0.2);
      color: #a78bfa;
    }

    /* Add tooltip for buttons */
    .action-btn:hover::after {
      content: attr(title);
      position: absolute;
      bottom: 125%;
      left: 50%;
      transform: translateX(-50%);
      background-color: #4b5563;
      color: white;
      padding: 0.25rem 0.5rem;
      border-radius: 0.25rem;
      font-size: 0.75rem;
      white-space: nowrap;
      z-index: 10;
    }

    /* Animations and transitions */
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    @keyframes fadeOut {
      from { opacity: 1; transform: translateY(0); }
      to { opacity: 0; transform: translateY(10px); }
    }

    @keyframes scaleIn {
      from { transform: scale(0.95); opacity: 0; }
      to { transform: scale(1); opacity: 1; }
    }

    @keyframes pulse {
      0% { transform: scale(0.95); opacity: 0.8; }
      70% { transform: scale(1.1); opacity: 1; }
      100% { transform: scale(0.95); opacity: 0.8; }
    }

    @keyframes slideIn {
      from { transform: translateY(20px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }

    @keyframes shake {
      0%, 100% { transform: translateX(0); }
      25% { transform: translateX(-5px); }
      75% { transform: translateX(5px); }
    }

    @keyframes glow {
      0% { box-shadow: 0 0 0 rgba(59, 130, 246, 0); }
      50% { box-shadow: 0 0 20px rgba(59, 130, 246, 0.5); }
      100% { box-shadow: 0 0 0 rgba(59, 130, 246, 0); }
    }

    /* Apply animations to elements */
    .feedback-item {
      animation: fadeIn 0.3s ease-out;
      transition: all 0.3s ease;
    }

    .feedback-item:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
    }

    .filter-btn, .page-size-btn, .action-btn {
      transition: all 0.2s ease;
    }

    .filter-btn:hover, .page-size-btn:hover {
      transform: translateY(-2px);
    }

    .filter-btn.active, .page-size-btn.active {
      animation: glow 2s infinite;
    }

    .action-btn:hover {
      transform: scale(1.2);
    }

    .action-btn:active {
      transform: scale(0.9);
    }

    .dialog-backdrop {
      transition: background-color 0.3s ease;
    }

    .dialog {
      animation: scaleIn 0.3s ease-out;
      transition: all 0.3s ease;
    }

    .conversation-item {
      animation: slideIn 0.3s ease-out;
      animation-fill-mode: both;
    }

    /* Stagger conversation items animation */
    .conversation-item:nth-child(1) { animation-delay: 0.05s; }
    .conversation-item:nth-child(2) { animation-delay: 0.1s; }
    .conversation-item:nth-child(3) { animation-delay: 0.15s; }
    .conversation-item:nth-child(4) { animation-delay: 0.2s; }
    .conversation-item:nth-child(5) { animation-delay: 0.25s; }
    .conversation-item:nth-child(6) { animation-delay: 0.3s; }

    /* Animate search input */
    .search-input:focus {
      animation: glow 2s infinite;
    }

    /* Animate tags */
    .tag {
      transition: all 0.2s ease;
    }

    .tag:hover {
      transform: scale(1.05);
    }

    /* Custom animation for archive button */
    .action-btn.archive:hover svg {
      animation: shake 0.5s ease;
    }

    /* Custom animation for thumbs */
    .action-btn.positive:hover svg,
    .action-btn.negative:hover svg {
      animation: pulse 1s infinite;
    }

    /* Animate the page when switching between showing/hiding archived */
    .container {
      transition: padding 0.3s ease;
    }

    /* No results animation */
    .no-results {
      animation: fadeIn 0.5s ease-out;
    }

    /* No results */
    .no-results {
      text-align: center;
      padding: 2.5rem 0;
      color: #9ca3af;
    }

    /* Dialog */
    .dialog-backdrop {
      position: fixed;
      inset: 0;
      background-color: rgba(0, 0, 0, 0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 1rem;
      z-index: 50;
    }

    .dialog {
      background-color: #1f2937;
      border-radius: 0.5rem;
      width: 100%;
      max-width: 48rem;
      max-height: 80vh;
      display: flex;
      flex-direction: column;
      box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
    }

    .dialog-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 1rem;
      border-bottom: 1px solid #374151;
    }

    .dialog-title {
      font-size: 1.125rem;
      font-weight: 500;
      color: white;
      display: flex;
      align-items: center;
    }

    .dialog-title svg {
      width: 1.25rem;
      height: 1.25rem;
      margin-right: 0.5rem;
    }

    .dialog-close {
      color: #9ca3af;
      background: none;
      border: none;
      cursor: pointer;
      padding: 0.25rem;
    }

    .dialog-close:hover {
      color: white;
    }

    .dialog-content {
      overflow-y: auto;
      padding: 1rem;
      flex-grow: 1;
    }

    .conversation-item {
      margin-bottom: 1rem;
    }

    .conversation-item.user {
      text-align: right;
    }

    .conversation-item.assistant {
      text-align: left;
    }

    .conversation-bubble {
      display: inline-block;
      max-width: 80%;
      padding: 0.75rem;
      border-radius: 0.5rem;
      white-space: pre-line;
    }

    .conversation-item.user .conversation-bubble {
      background-color: #2563eb;
      color: white;
      border-top-right-radius: 0;
    }

    .conversation-item.assistant .conversation-bubble {
      background-color: #374151;
      color: white;
      border-top-left-radius: 0;
    }

    .conversation-role {
      font-size: 0.875rem;
      font-weight: 500;
      margin-bottom: 0.25rem;
      opacity: 0.7;
    }

    /* Hidden class */
    .hidden {
      display: none;
    }

    /* Animation overlay */
    .animation-overlay {
      position: absolute;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 0.5rem;
      background-color: rgba(0, 0, 0, 0.3);
      z-index: 20;
    }

    .animation-overlay.positive {
      background-color: rgba(16, 185, 129, 0.3);
    }

    .animation-overlay.negative {
      background-color: rgba(239, 68, 68, 0.3);
    }

    .animation-icon {
      width: 4rem;
      height: 4rem;
      animation: pulse 1s infinite;
    }

    .animation-icon.positive {
      color: #10b981;
    }

    .animation-icon.negative {
      color: #ef4444;
    }

    /* MongoDB Connection Styles */
    .connection-status {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      margin-bottom: 1rem;
      font-size: 0.875rem;
    }

    .connection-status .status-indicator {
      width: 0.75rem;
      height: 0.75rem;
      border-radius: 50%;
      background-color: #9ca3af;
    }

    .connection-status .status-indicator.connected {
      background-color: #10b981;
    }

    .connection-status .status-indicator.disconnected {
      background-color: #ef4444;
    }

    /* Schema selection styles */
    .schema-select-container {
      margin-bottom: 1rem;
    }

    .schema-select {
      background-color: #1f2937;
      border: 1px solid #374151;
      color: #f3f4f6;
      padding: 0.5rem;
      border-radius: 0.25rem;
      width: 100%;
    }

    /* Dialog Controls */
    .dialog-controls {
      padding: 1rem;
      border-top: 1px solid #374151;
      display: flex;
      gap: 1rem;
      flex-wrap: wrap;
    }

    .schema-select-container {
      flex-grow: 1;
    }

    .schema-select-container label {
      display: flex;
      align-items: center;
      margin-bottom: 0.75rem;
      font-weight: 500;
      color: #d1d5db;
    }

    .schema-select-container label svg {
      margin-right: 0.5rem;
    }

    .schema-button-group {
      display: flex;
      gap: 0.5rem;
      flex-wrap: wrap;
    }

    .schema-btn {
      padding: 0.5rem 1rem;
      border-radius: 0.25rem;
      background-color: #1f2937;
      color: #f3f4f6;
      border: 1px solid #374151;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .schema-btn:hover {
      background-color: #2d3748;
      transform: translateY(-2px);
    }

    .schema-btn.active {
      background-color: #2563eb;
      color: white;
      border-color: #2563eb;
    }

    /* Edit Message Styles */
    .edit-btn {
      padding: 0.5rem 1rem;
      border-radius: 0.25rem;
      background-color: #2563eb;
      color: white;
      border: none;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      transition: all 0.2s ease;
    }

    .edit-btn:hover {
      background-color: #1d4ed8;
      transform: translateY(-2px);
    }

    .cancel-btn {
      background-color: #4b5563;
    }

    .cancel-btn:hover {
      background-color: #374151;
    }

    .edit-message-container {
      padding: 1rem;
      border-top: 1px solid #374151;
    }

    .edit-message-textarea {
      background-color: #111827;
      border: 1px solid #374151;
      color: #f3f4f6;
      padding: 1rem;
      border-radius: 0.5rem;
      resize: vertical;
      min-height: 12rem;
      width: 100%;
      font-family: monospace;
      font-size: 0.875rem;
      line-height: 1.5;
      margin-bottom: 1rem;
    }

    .edit-message-textarea:focus {
      outline: none;
      border-color: #3b82f6;
      box-shadow: 0 0 0 1px #3b82f6;
    }

    .edit-instructions {
      padding: 0.75rem;
      background-color: #1f2937;
      border-radius: 0.25rem;
      margin-bottom: 1rem;
      font-size: 0.875rem;
    }

    .edit-instructions code {
      background-color: #111827;
      padding: 0.125rem 0.25rem;
      border-radius: 0.25rem;
      font-family: monospace;
    }

    .edit-buttons {
      display: flex;
      gap: 0.5rem;
      justify-content: flex-end;
    }

    /* Type indicator */
    .type-tag {
      background-color: #4b5563;
      color: #f3f4f6;
    }

    /* Tabs styling */
    .tabs-container {
      margin-bottom: 1rem;
    }

    .tabs-header {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      margin-bottom: 1rem;
      overflow-x: auto;
      padding-bottom: 0.5rem;
    }

    .tabs-list {
      display: flex;
      gap: 0.25rem;
      flex-wrap: nowrap;
      overflow-x: auto;
      scrollbar-width: thin;
      scrollbar-color: #4b5563 #1f2937;
      padding: 0.25rem 0;
      flex-grow: 1;
    }

    .tabs-list::-webkit-scrollbar {
      height: 6px;
    }

    .tabs-list::-webkit-scrollbar-track {
      background: #1f2937;
      border-radius: 3px;
    }

    .tabs-list::-webkit-scrollbar-thumb {
      background-color: #4b5563;
      border-radius: 3px;
    }

    .tab-btn {
      padding: 0.5rem 0.75rem;
      background-color: #1f2937;
      color: #d1d5db;
      border: none;
      border-radius: 0.25rem;
      cursor: pointer;
      white-space: nowrap;
      transition: all 0.2s ease;
    }

    .tab-btn:hover {
      background-color: #374151;
      transform: translateY(-2px);
    }

    .tab-btn.active {
      background-color: #2563eb;
      color: white;
      animation: glow 2s infinite;
    }

    .tab-nav-btn {
      padding: 0.5rem 0.75rem;
      background-color: #1f2937;
      color: #d1d5db;
      border: none;
      border-radius: 0.25rem;
      cursor: pointer;
      white-space: nowrap;
      transition: all 0.2s ease;
      flex-shrink: 0;
    }

    .tab-nav-btn:hover {
      background-color: #374151;
    }

    .tab-nav-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
  </style>
</head>
<body>
<div class="container">
  <h1>Mürşit Feedback Sistemi</h1>

  <!-- MongoDB Connection Status -->
  <div class="connection-status">
    <div id="connection-indicator" class="status-indicator"></div>
    <span id="connection-text">Connecting to MongoDB...</span>
  </div>

  <!-- Search Bar -->
  <div class="search-container">
    <svg class="search-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <circle cx="11" cy="11" r="8"></circle>
      <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
    </svg>
    <input type="text" id="search-input" class="search-input" placeholder="Search questions or queries...">
  </div>

  <!-- Schema Filter Buttons -->
  <div class="filter-section">
    <div class="filter-label">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"></polygon>
      </svg>
      <span>Şema Filtreleri:</span>
    </div>
    <div id="schema-filters" class="filter-buttons">
      <button data-schema="Mesai" class="filter-btn">Mesai</button>
      <button data-schema="Mukavele" class="filter-btn">Mukavele</button>
      <button data-schema="Genel" class="filter-btn">Genel</button>
    </div>
  </div>

  <!-- Type Filter Buttons -->
  <div class="filter-section">
    <div class="filter-label">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <path d="M12 20h9"></path>
        <path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"></path>
      </svg>
      <span>Tip Filtreleri:</span>
    </div>
    <div id="type-filters" class="filter-buttons"></div>
  </div>

  <!-- Feedback Filter Buttons -->
  <div class="feedback-filters">
    <div class="filter-label">
      <span>Feedback Filtreleri:</span>
    </div>
    <button id="positive-filter" class="filter-btn">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="display: inline; margin-right: 4px;">
        <path d="M7 10v12"></path>
        <path d="M15 5.88 14 10h5.83a2 2 0 0 1 1.92 2.56l-2.33 8A2 2 0 0 1 17.5 22H4a2 2 0 0 1-2-2v-8a2 2 0 0 1 2-2h2.76a2 2 0 0 0 1.79-1.11L12 2h0a3.13 3.13 0 0 1 3 3.88Z"></path>
      </svg>
      Positive
    </button>
    <button id="negative-filter" class="filter-btn">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="display: inline; margin-right: 4px;">
        <path d="M17 14V2"></path>
        <path d="M9 18.12 10 14H4.17a2 2 0 0 1-1.92-2.56l2.33-8A2 2 0 0 1 6.5 2H20a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2h-2.76a2 2 0 0 0-1.79 1.11L12 22h0a3.13 3.13 0 0 1-3-3.88Z"></path>
      </svg>
      Negative
    </button>
    <button id="hidden-filter" class="filter-btn">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="display: inline; margin-right: 4px;">
        <rect width="20" height="5" x="2" y="3" rx="1"></rect>
        <path d="M4 8v11a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8"></path>
        <path d="M10 12h4"></path>
      </svg>
      Show Archived
    </button>
  </div>

  <!-- Page Size Selection -->
  <div class="page-size">
    <span>Gösterilecek:</span>
    <button data-size="20" class="page-size-btn active">20</button>
    <button data-size="40" class="page-size-btn">40</button>
    <button data-size="100" class="page-size-btn">100</button>
    <button data-size="200" class="page-size-btn">200</button>
  </div>

  <!-- Tabs Navigation -->
  <div id="tabs-container" class="tabs-container">
    <div class="tabs-header">
      <button id="prev-tab-btn" class="tab-nav-btn">&laquo; Previous</button>
      <div id="tabs-list" class="tabs-list"></div>
      <button id="next-tab-btn" class="tab-nav-btn">Next &raquo;</button>
    </div>
  </div>

  <!-- Results count -->
  <div id="results-count" class="results-count"></div>

  <!-- Feedback Items -->
  <div id="feedback-items" class="feedback-items"></div>

  <!-- No results message -->
  <div id="no-results" class="no-results hidden">
    No questions found matching your criteria
  </div>

  <!-- Conversation Dialog -->
  <div id="dialog-backdrop" class="dialog-backdrop hidden">
    <div id="dialog" class="dialog">
      <div class="dialog-header">
        <h3 id="dialog-title" class="dialog-title">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
          </svg>
          Conversation
        </h3>
        <button id="dialog-close" class="dialog-close">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <circle cx="12" cy="12" r="10"></circle>
            <line x1="15" y1="9" x2="9" y2="15"></line>
            <line x1="9" y1="9" x2="15" y2="15"></line>
          </svg>
        </button>
      </div>
      <div id="dialog-content" class="dialog-content"></div>

      <!-- Schema Selection in Dialog -->
      <div class="dialog-controls">
        <div class="schema-select-container">
          <label for="schema-select">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"></polygon>
            </svg>
            Assign Schema:
          </label>
          <div class="schema-button-group">
            <button class="schema-btn" data-schema="Mesai">Mesai</button>
            <button class="schema-btn" data-schema="Mukavele">Mukavele</button>
            <button class="schema-btn" data-schema="Genel">Genel</button>
          </div>
        </div>

        <!-- Edit Message Button -->
        <button id="edit-messages-btn" class="edit-btn">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M12 20h9"></path>
            <path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"></path>
          </svg>
          Edit Messages
        </button>
      </div>

      <!-- Edit Message Container (Hidden by Default) -->
      <div id="edit-message-container" class="edit-message-container hidden">
        <textarea id="edit-message-textarea" class="edit-message-textarea"></textarea>
        <div class="edit-instructions">
          <p>Format: <code>[role] message content</code></p>
          <p>Separate messages with blank lines</p>
        </div>
        <div class="edit-buttons">
          <button id="cancel-edit-btn" class="edit-btn cancel-btn">Cancel</button>
          <button id="save-edit-btn" class="edit-btn">Save Changes</button>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  // MongoDB API config
  const API_BASE_URL = "http://localhost:3000/api"; // Change this to your deployed API URL in production

  // DOM elements
  const searchInput = document.getElementById('search-input');
  const schemaFilters = document.getElementById('schema-filters');
  const typeFilters = document.getElementById('type-filters');
  const positiveFilter = document.getElementById('positive-filter');
  const negativeFilter = document.getElementById('negative-filter');
  const hiddenFilter = document.getElementById('hidden-filter');
  const pageSizeButtons = document.querySelectorAll('.page-size-btn');
  const resultsCount = document.getElementById('results-count');
  const feedbackItems = document.getElementById('feedback-items');
  const noResults = document.getElementById('no-results');
  const dialogBackdrop = document.getElementById('dialog-backdrop');
  const dialog = document.getElementById('dialog');
  const dialogTitle = document.getElementById('dialog-title');
  const dialogContent = document.getElementById('dialog-content');
  const dialogClose = document.getElementById('dialog-close');
  const connectionIndicator = document.getElementById('connection-indicator');
  const connectionText = document.getElementById('connection-text');
  const schemaButtons = document.querySelectorAll('.schema-btn');
  const editMessagesBtn = document.getElementById('edit-messages-btn');
  const editMessageContainer = document.getElementById('edit-message-container');
  const editMessageTextarea = document.getElementById('edit-message-textarea');
  const cancelEditBtn = document.getElementById('cancel-edit-btn');
  const saveEditBtn = document.getElementById('save-edit-btn');
  const tabsContainer = document.getElementById('tabs-container');

  // App state
  let data = [];
  let filteredData = [];
  let activeSchema = null;
  let activeTypeFilter = null;
  let activeFeedbackFilter = null;
  let showHidden = false;
  let pageSize = 20;
  let searchQuery = '';
  let activeAnimationId = null;
  let animationTimeout = null;
  let currentItemId = null;
  let schemaList = ["Mesai", "Mukavele", "Genel"];
  let currentPage = 0;
  let totalPages = 0;
  let visibleTabCount = 5; // Number of tabs to show at once

  // Sample MongoDB Data (replace with actual API call in production)
  const sampleMongoData = [
    {
      "_id": {"$oid":"67c304044ce2c5104a9879fb"},
      "RDate": {"$date":{"$numberLong":"1740833796639"}},
      "botVersion": "v2",
      "conversationId": "7414af7c-4ea6-4b1f-836b-0c28b3ca60b6",
      "groupId": "9b6db698-f69c-11ef-9a83-0242ac130002",
      "messages": "[{role=user, content=En çok mail yazışmasının bulunduğu künye hangisidir}, {role=assistant, content={include=[], exclude=[], doctype=[all], searchType=null, reduced_user_message=En çok mail yazışmasının bulunduğu künye hangisidir}}]",
      "timestamp": {"$numberInt":"1740833797"},
      "type": "elastic-agent",
      "userName": "esodazai",
      "uuid": "9c1ed432-f69c-11ef-9a83-0242ac130002",
      "schema": "Mesai",
      "feedback": "positive",
      "hidden": false
    },
    {
      "_id": {"$oid":"67c304044ce2c5104a9879fc"},
      "RDate": {"$date":{"$numberLong":"1740833796640"}},
      "botVersion": "v2",
      "conversationId": "7414af7c-4ea6-4b1f-836b-0c28b3ca60b7",
      "groupId": "9b6db698-f69c-11ef-9a83-0242ac130003",
      "messages": "[{role=user, content=Bu hafta izin günlerim ne zaman?}, {role=assistant, content={include=[], exclude=[], doctype=[all], searchType=null, reduced_user_message=Bu hafta izin günlerim ne zaman?}}]",
      "timestamp": {"$numberInt":"1740833798"},
      "type": "elastic-agent",
      "userName": "testsuser",
      "uuid": "9c1ed432-f69c-11ef-9a83-0242ac130003",
      "schema": "İzin",
      "feedback": "negative",
      "hidden": false
    },
    {
      "_id": {"$oid":"67c304044ce2c5104a9879fd"},
      "RDate": {"$date":{"$numberLong":"1740833796641"}},
      "botVersion": "v2",
      "conversationId": "7414af7c-4ea6-4b1f-836b-0c28b3ca60b8",
      "groupId": "9b6db698-f69c-11ef-9a83-0242ac130004",
      "messages": "[{role=user, content=Son maaş bordrom nerede?}, {role=assistant, content={include=[], exclude=[], doctype=[all], searchType=null, reduced_user_message=Son maaş bordrom nerede?}}]",
      "timestamp": {"$numberInt":"1740833799"},
      "type": "chat-agent",
      "userName": "demoaccount",
      "uuid": "9c1ed432-f69c-11ef-9a83-0242ac130004",
      "schema": "Bordro",
      "feedback": null,
      "hidden": true
    }
  ];

  // Fix 1: Optimized MongoDB data conversion to app format (removes originalData duplication)
  function convertMongoDataToAppFormat(mongoData) {
    if (!mongoData || !Array.isArray(mongoData)) {
      console.error("Invalid MongoDB data:", mongoData);
      return [];
    }

    try {
      return mongoData.map(item => {
        try {
          // Handle various message formats
          let parsedMessages;
          if (typeof item.messages === 'string') {
            parsedMessages = parseMessages(item.messages);
          } else if (Array.isArray(item.messages)) {
            parsedMessages = parseMessages(item.messages);
          } else {
            parsedMessages = [
              { role: 'user', message: 'No messages available' }
            ];
          }

          // Find the first user message for title
          const firstUserMessage = parsedMessages.find(msg => msg.role === 'user');

          // Handle different MongoDB ID formats
          const id = item._id?.$oid || item._id || item.id;

          if (!id) {
            console.warn("Item missing ID:", item);
          }

          return {
            id: id || `temp-${Date.now()}-${Math.random().toString(36).substring(2, 9)}`,
            schema: item.schema || '',
            question: firstUserMessage ? firstUserMessage.message : 'No question found',
            query: firstUserMessage ? firstUserMessage.message : '',
            feedback: item.feedback || null,
            hidden: item.hidden || false,
            conversation: parsedMessages,
            timestamp: item.timestamp || '',
            type: item.type || 'Unknown',
            userName: item.userName || ''
            // Removed: originalData: item - This was causing memory duplication
          };
        } catch (itemError) {
          console.error("Error converting item:", itemError, item);
          return null;
        }
      }).filter(Boolean); // Remove any null items from errors
    } catch (error) {
      console.error("Error converting MongoDB data:", error);
      return [];
    }
  }

  // Memory-efficient message parsing without eval() and multiple try/catch blocks
  function parseMessages(messagesString) {
    // Handle non-string input
    if (typeof messagesString !== 'string') {
      // If it's already an object/array, process it directly
      if (typeof messagesString === 'object' && messagesString !== null) {
        if (Array.isArray(messagesString)) {
          return messagesString.map(msg => ({
            role: msg.role || 'unknown',
            message: typeof msg.content === 'object' ?
                    JSON.stringify(msg.content) :
                    msg.content || 'No content'
          }));
        }

        // If single object, convert to array
        return [{
          role: messagesString.role || 'unknown',
          message: typeof messagesString.content === 'object' ?
                  JSON.stringify(messagesString.content) :
                  messagesString.content || 'No content'
        }];
      }

      // Return default for non-string non-object
      console.warn('Messages is not a string or object:', messagesString);
      return [
        { role: 'user', message: 'Message parsing error' },
        { role: 'assistant', message: 'Unable to parse messages' }
      ];
    }

    try {
      // Clean the string to make it more JSON-like
      let cleanedString = messagesString
              .replace(/([a-zA-Z]+)=/g, '"$1":')  // Convert property=value to "property":value
              .replace(/'/g, '"')                  // Replace single quotes with double quotes
              .replace(/\"\{/g, '{')              // Fix any malformed quotes before brackets
              .replace(/\}\"/g, '}');             // Fix any malformed quotes after brackets

      // Try to parse as JSON
      try {
        const parsed = JSON.parse(cleanedString);
        if (Array.isArray(parsed)) {
          return parsed.map(msg => ({
            role: msg.role || 'unknown',
            message: typeof msg.content === 'object' ?
                    (msg.content.reduced_user_message || JSON.stringify(msg.content)) :
                    msg.content || 'No content'
          }));
        }
      } catch (jsonError) {
        // Continue to regex approach if JSON parsing fails
      }

      // Use regex to extract content - covers most common formats
      const regex = /\{(?:['"]?role['"]?[:=]\s*['"]?(.*?)['"]?[,}]).*?(?:['"]?content['"]?[:=]\s*(.*?)(?=\s*[,}]|$))/g;
      const matches = [];
      let match;

      while ((match = regex.exec(messagesString)) !== null) {
        const role = match[1]?.trim() || 'unknown';
        let content = match[2];

        // Clean up content
        if (content) {
          // Remove surrounding quotes if present
          content = content.replace(/^['"]|['"]$/g, '');

          // Handle object content - simplified approach
          if (content.startsWith('{') && content.endsWith('}')) {
            try {
              const contentObj = JSON.parse(content.replace(/'/g, '"'));
              content = contentObj.reduced_user_message || JSON.stringify(contentObj);
            } catch (e) {
              // Keep as is if parsing fails
            }
          }
        }

        matches.push({
          role: role,
          message: content || 'No content'
        });
      }

      if (matches.length > 0) {
        return matches;
      }

      // Last resort simple format detection
      if (messagesString.includes('role') && messagesString.includes('content')) {
        const items = messagesString.split('},').map(part => part.trim() + (part.endsWith('}') ? '' : '}'));

        return items.map(item => {
          const roleMatch = item.match(/role['":\s=]+(['"]?)(.*?)\1[,}]/i);
          const contentMatch = item.match(/content['":\s=]+(['"]?)(.*?)\1[,}]/i);

          return {
            role: roleMatch ? roleMatch[2].trim() : 'unknown',
            message: contentMatch ? contentMatch[2].trim() : 'No content'
          };
        });
      }

      // Return default for unparseable content
      return [
        { role: 'user', message: 'Error parsing message content' }
      ];
    } catch (error) {
      console.error("Critical error parsing messages:", error);
      return [
        { role: 'user', message: 'Error parsing message' }
      ];
    }
  }

  // Connect to MongoDB via API with pagination
  async function connectToMongoDB(page = 0) {
    try {
      // Show connecting status
      connectionIndicator.classList.remove('connected');
      connectionIndicator.classList.remove('disconnected');
      connectionText.textContent = `Connecting to MongoDB (page ${page + 1})...`;

      // Clear existing data
      data = [];
      filteredData = [];

      // Fetch data from our backend API with pagination
      const response = await fetch(`${API_BASE_URL}/conversations?page=${page}&limit=${pageSize}`);

      if (!response.ok) {
        throw new Error(`API responded with status: ${response.status}`);
      }

      const result = await response.json();
      console.log("API response:", result);

      let mongoData;
      if (result.data) {
        mongoData = result.data;

        // Update pagination info
        currentPage = result.pagination.page;
        totalPages = result.pagination.totalPages;
      } else {
        // Handle old API format
        mongoData = result;
        currentPage = 0;
        totalPages = 1;
      }

      // Update connection status
      connectionIndicator.classList.add('connected');
      connectionText.textContent = `Connected to MongoDB - ${mongoData.length} records loaded`;

      if (result.pagination) {
        connectionText.textContent += ` (Page ${currentPage + 1} of ${totalPages} - Total: ${result.pagination.totalCount})`;
      }

      // Convert and store data
      data = convertMongoDataToAppFormat(mongoData);
      console.log("Converted data:", data);

      filteredData = [...data.filter(item => !item.hidden)];

      // Initialize schema and type filters
      initializeSchemaFilters();
      initializeTypeFilters();

      // Initialize tabs
      initializeTabs(totalPages);

      // Render items
      renderItems();

    } catch (error) {
      console.error('Error connecting to MongoDB:', error);
      connectionIndicator.classList.add('disconnected');
      connectionText.textContent = 'Failed to connect to MongoDB: ' + error.message;

      // For development/testing only - fall back to sample data
      if (confirm('Connection to API failed. Use sample data instead?')) {
        const mongoData = sampleMongoData;
        data = convertMongoDataToAppFormat(mongoData);
        console.log("Sample data:", data);

        filteredData = [...data.filter(item => !item.hidden)];

        // Initialize filters
        initializeSchemaFilters();
        initializeTypeFilters();

        // Mock pagination for sample data
        currentPage = 0;
        totalPages = 1;
        initializeTabs(totalPages);

        renderItems();
      }
    }
  }

  // Initialize tab navigation
  function initializeTabs(totalPages) {
    const tabsList = document.getElementById('tabs-list');
    const prevTabBtn = document.getElementById('prev-tab-btn');
    const nextTabBtn = document.getElementById('next-tab-btn');

    // Clear existing tabs
    tabsList.innerHTML = '';

    // Create tabs
    for (let i = 0; i < totalPages; i++) {
      const tab = document.createElement('button');
      tab.className = `tab-btn${currentPage === i ? ' active' : ''}`;
      tab.textContent = `Page ${i + 1}`;
      tab.dataset.page = i;

      tab.addEventListener('click', () => {
        if (currentPage !== i) {
          loadPage(i);
        }
      });

      tabsList.appendChild(tab);
    }

    // Update tab visibility based on current page
    updateTabsVisibility();

    // Update navigation buttons
    prevTabBtn.disabled = currentPage === 0;
    nextTabBtn.disabled = currentPage === totalPages - 1;

    // Add event listeners to navigation buttons
    prevTabBtn.addEventListener('click', () => {
      if (currentPage > 0) {
        loadPage(currentPage - 1);
      }
    });

    nextTabBtn.addEventListener('click', () => {
      if (currentPage < totalPages - 1) {
        loadPage(currentPage + 1);
      }
    });
  }

  // Load specific page
  async function loadPage(page) {
    // Show loading state
    connectionText.textContent = `Loading page ${page + 1}...`;

    try {
      // Fetch data for specific page
      const response = await fetch(`${API_BASE_URL}/conversations?page=${page}&limit=${pageSize}`);

      if (!response.ok) {
        throw new Error(`API responded with status: ${response.status}`);
      }

      const result = await response.json();
      const mongoData = result.data;

      // Update current page
      currentPage = page;

      // Convert and store data
      data = convertMongoDataToAppFormat(mongoData);
      filteredData = [...data.filter(item => !item.hidden)];

      // Update filters if the page has different types
      initializeTypeFilters();

      // Update tabs
      const tabButtons = document.querySelectorAll('.tab-btn');
      tabButtons.forEach(tab => {
        const tabPage = parseInt(tab.dataset.page);
        tab.classList.toggle('active', tabPage === currentPage);
      });

      // Update tab visibility
      updateTabsVisibility();

      // Update navigation buttons
      document.getElementById('prev-tab-btn').disabled = currentPage === 0;
      document.getElementById('next-tab-btn').disabled = currentPage === totalPages - 1;

      // Update connection status
      connectionText.textContent = `Page ${currentPage + 1} of ${totalPages} - Total records: ${result.pagination.totalCount}`;

      // Render items
      renderItems();

    } catch (error) {
      console.error('Error loading page:', error);
      connectionText.textContent = `Failed to load page ${page + 1}: ${error.message}`;
    }
  }

  // Update which tabs are visible
  function updateTabsVisibility() {
    const tabButtons = document.querySelectorAll('.tab-btn');

    // Calculate start and end indexes for visible tabs
    let startIndex = Math.max(0, currentPage - Math.floor(visibleTabCount / 2));
    let endIndex = Math.min(totalPages - 1, startIndex + visibleTabCount - 1);

    // Adjust start index if needed
    if (endIndex - startIndex + 1 < visibleTabCount) {
      startIndex = Math.max(0, endIndex - visibleTabCount + 1);
    }

    // Show/hide tabs based on calculated range
    tabButtons.forEach((tab, index) => {
      tab.style.display = (index >= startIndex && index <= endIndex) ? 'block' : 'none';
    });
  }

  // Initialize schema filter buttons
  function initializeSchemaFilters() {
    // Set up event listeners for schema filter buttons
    const schemaFilterButtons = document.querySelectorAll('#schema-filters .filter-btn');
    schemaFilterButtons.forEach(button => {
      const schema = button.dataset.schema;
      button.addEventListener('click', () => filterBySchema(schema));

      // Add active class if this schema is currently filtered
      if (activeSchema === schema) {
        button.classList.add('active');
      }
    });
  }

  // Initialize type filters based on available types in data
  function initializeTypeFilters() {
    // Clear existing filters
    typeFilters.innerHTML = '';

    // Get unique types
    const uniqueTypes = [...new Set(data.map(item => item.type || 'Unknown'))];

    // If no types found, add a placeholder message
    if (!uniqueTypes.length || (uniqueTypes.length === 1 && uniqueTypes[0] === 'Unknown')) {
      const message = document.createElement('span');
      message.className = 'filter-message';
      message.textContent = 'No types found in current data';
      typeFilters.appendChild(message);
      return;
    }

    // Add buttons for each type
    uniqueTypes.forEach(type => {
      const button = document.createElement('button');
      button.textContent = type;
      button.className = 'filter-btn';
      button.dataset.type = type;

      // Mark as active if it matches the current filter
      if (activeTypeFilter === type) {
        button.classList.add('active');
      }

      button.addEventListener('click', () => filterByType(type));

      // Add an icon to the button
      const iconSvg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
      iconSvg.setAttribute('width', '12');
      iconSvg.setAttribute('height', '12');
      iconSvg.setAttribute('viewBox', '0 0 24 24');
      iconSvg.setAttribute('fill', 'none');
      iconSvg.setAttribute('stroke', 'currentColor');
      iconSvg.setAttribute('stroke-width', '2');
      iconSvg.setAttribute('stroke-linecap', 'round');
      iconSvg.setAttribute('stroke-linejoin', 'round');

      const iconPath = document.createElementNS('http://www.w3.org/2000/svg', 'path');
      iconPath.setAttribute('d', 'M12 20h9');
      iconSvg.appendChild(iconPath);

      const iconPath2 = document.createElementNS('http://www.w3.org/2000/svg', 'path');
      iconPath2.setAttribute('d', 'M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z');
      iconSvg.appendChild(iconPath2);

      button.prepend(iconSvg);
      typeFilters.appendChild(button);
    });
  }

  // Filter by schema
  function filterBySchema(schema) {
    const button = document.querySelector(`.filter-btn[data-schema="${schema}"]`);

    if (activeSchema === schema) {
      activeSchema = null;
      button.classList.remove('active');
    } else {
      // Remove active class from all schema buttons
      document.querySelectorAll('.filter-btn[data-schema]').forEach(btn => {
        btn.classList.remove('active');
      });

      activeSchema = schema;
      button.classList.add('active');
    }

    applyFilters();
  }

  // Feedback filter event listeners
  positiveFilter.addEventListener('click', () => {
    if (activeFeedbackFilter === 'positive') {
      activeFeedbackFilter = null;
      positiveFilter.classList.remove('active');
    } else {
      activeFeedbackFilter = 'positive';
      positiveFilter.classList.add('active');
      negativeFilter.classList.remove('active');
    }

    applyFilters();
  });

  negativeFilter.addEventListener('click', () => {
    if (activeFeedbackFilter === 'negative') {
      activeFeedbackFilter = null;
      negativeFilter.classList.remove('active');
    } else {
      activeFeedbackFilter = 'negative';
      negativeFilter.classList.add('active');
      positiveFilter.classList.remove('active');
    }

    applyFilters();
  });

  // Toggle hidden items
  hiddenFilter.addEventListener('click', () => {
    showHidden = !showHidden;

    if (showHidden) {
      hiddenFilter.classList.add('active');
      hiddenFilter.textContent = 'Hide Archived';
      hiddenFilter.innerHTML = `
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="display: inline; margin-right: 4px;">
            <rect width="20" height="5" x="2" y="3" rx="1"></rect>
            <path d="M4 8v11a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8"></path>
            <path d="M10 12h4"></path>
          </svg>
          Hide Archived
        `;
    } else {
      hiddenFilter.classList.remove('active');
      hiddenFilter.innerHTML = `
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="display: inline; margin-right: 4px;">
            <rect width="20" height="5" x="2" y="3" rx="1"></rect>
            <path d="M4 8v11a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8"></path>
            <path d="M10 12h4"></path>
          </svg>
          Show Archived
        `;
    }

    applyFilters();
  });

  // Search functionality
  searchInput.addEventListener('input', () => {
    searchQuery = searchInput.value.toLowerCase();
    applyFilters();
  });

  // Page size buttons
  pageSizeButtons.forEach(button => {
    button.addEventListener('click', () => {
      pageSizeButtons.forEach(btn => btn.classList.remove('active'));
      button.classList.add('active');
      pageSize = parseInt(button.dataset.size);
      renderItems();
    });
  });

  // Dialog close button
  dialogClose.addEventListener('click', closeDialog);
  dialogBackdrop.addEventListener('click', event => {
    if (event.target === dialogBackdrop) {
      closeDialog();
    }
  });

  // Close dialog with ESC key
  document.addEventListener('keydown', event => {
    if (event.key === 'Escape' && !dialogBackdrop.classList.contains('hidden')) {
      closeDialog();
    }
  });

  // Edit messages button
  editMessagesBtn.addEventListener('click', () => {
    const item = data.find(item => item.id === currentItemId);
    if (item) {
      // Format messages into a readable format for editing
      const formattedMessages = item.conversation.map(msg =>
              `[${msg.role}] ${msg.message}`
      ).join('\n\n');

      editMessageTextarea.value = formattedMessages;
      editMessageContainer.classList.remove('hidden');
    }
  });

  // Cancel edit button
  cancelEditBtn.addEventListener('click', () => {
    editMessageContainer.classList.add('hidden');
  });

  // Save edit button
  saveEditBtn.addEventListener('click', async () => {
    const editedText = editMessageTextarea.value;
    const item = data.find(item => item.id === currentItemId);

    if (item) {
      try {
        // Parse the edited text back into conversation format
        const messageLines = editedText.split('\n\n').filter(Boolean);
        const newConversation = messageLines.map(line => {
          const roleMatch = line.match(/^\[(.*?)\]/);
          const role = roleMatch ? roleMatch[1] : 'user';
          const message = line.replace(/^\[(.*?)\]\s*/, '');

          return { role, message };
        });

        // Update the conversation locally
        item.conversation = newConversation;

        // Format messages back to MongoDB string format
        const messagesString = JSON.stringify(
                newConversation.map(msg => ({
                  role: msg.role,
                  content: msg.message
                }))
        ).replace(/"/g, "'");

        // Update MongoDB via API
        try {
          const response = await fetch(`${API_BASE_URL}/conversations/${currentItemId}/messages`, {
            method: 'PATCH',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({ messages: messagesString })
          });

          if (!response.ok) {
            console.error('Error updating messages:', await response.text());
            alert('Failed to update messages on server. Please try again.');
            return;
          }

          // Update question title if first user message changed
          const firstUserMessage = newConversation.find(msg => msg.role === 'user');
          if (firstUserMessage) {
            item.question = firstUserMessage.message;
            item.query = firstUserMessage.message;
          }

          // Hide edit container
          editMessageContainer.classList.add('hidden');

          // Refresh dialog content
          openDialog(item);

          // Show success message
          alert('Messages updated successfully!');

          // Refresh items to update any titles
          applyFilters();
        } catch (error) {
          console.error('Failed to update messages:', error);
          alert('Failed to update messages: ' + error.message);
        }
      } catch (error) {
        console.error('Error parsing edited messages:', error);
        alert('Error updating messages. Please check format.');
      }
    }
  });

  // Schema select change handler
  schemaSelect.addEventListener('change', async () => {
    const selectedSchema = schemaSelect.value;
    const item = data.find(item => item.id === currentItemId);

    if (item && selectedSchema) {
      // Update schema locally first
      item.schema = selectedSchema;

      // Update MongoDB via API
      try {
        const response = await fetch(`${API_BASE_URL}/conversations/${currentItemId}/schema`, {
          method: 'PATCH',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ schema: selectedSchema })
        });

        if (!response.ok) {
          console.error('Error updating schema:', await response.text());
          alert('Failed to update schema on server. Please try again.');
          return;
        }

        // Show success message
        alert(`Schema updated to "${selectedSchema}"!`);

        // Refresh items
        applyFilters();
      } catch (error) {
        console.error('Failed to update schema:', error);
        alert('Failed to update schema: ' + error.message);
      }
    }
  });

  // Apply all filters
  function applyFilters() {
    let filtered = [...data];

    // Apply schema filter if active
    if (activeSchema) {
      filtered = filtered.filter(item => item.schema === activeSchema);
    }

    // Apply type filter if active
    if (activeTypeFilter) {
      filtered = filtered.filter(item => (item.type || 'Unknown') === activeTypeFilter);
    }

    // Apply feedback filter if active
    if (activeFeedbackFilter) {
      filtered = filtered.filter(item => item.feedback === activeFeedbackFilter);
    }

    // Apply hidden filter
    if (!showHidden) {
      filtered = filtered.filter(item => !item.hidden);
    }

    // Apply search query
    if (searchQuery) {
      filtered = filtered.filter(item =>
              (item.question && item.question.toLowerCase().includes(searchQuery)) ||
              (item.query && item.query.toLowerCase().includes(searchQuery))
      );
    }

    filteredData = filtered;
    renderItems();
  }

  // Render feedback items with animations
  function renderItems() {
    // Update results count
    resultsCount.textContent = `${Math.min(pageSize, filteredData.length)} taneden ${filteredData.length} farklı sonuç gösteriliyor`;

    // Clear items container with animation
    const existingItems = feedbackItems.querySelectorAll('.feedback-item');
    existingItems.forEach((item, index) => {
      // Stagger the removal for a nice effect
      setTimeout(() => {
        item.style.opacity = '0';
        item.style.transform = 'translateY(10px)';
      }, index * 50);
    });

    // Wait for animations to finish before rebuilding list
    setTimeout(() => {
      feedbackItems.innerHTML = '';

      // Show or hide no results message with animation
      if (filteredData.length === 0) {
        noResults.classList.remove('hidden');
        noResults.style.animation = 'fadeIn 0.5s ease-out';
      } else {
        noResults.classList.add('hidden');
      }

      // Render items with staggered animations
      filteredData.slice(0, pageSize).forEach((item, index) => {
        const itemElement = document.createElement('div');
        itemElement.className = `feedback-item${item.hidden ? ' hidden' : ''}${item.feedback === 'positive' ? ' positive' : item.feedback === 'negative' ? ' negative' : ''}`;
        itemElement.dataset.id = item.id;

        // Set initial animation state
        itemElement.style.opacity = '0';
        itemElement.style.transform = 'translateY(10px)';

        // Create item content
        itemElement.innerHTML = `
            <div class="feedback-header">
              <div class="feedback-content">
                <div class="feedback-tags">
                  ${item.schema ? `<span class="tag">${item.schema}</span>` : ''}
                  <span class="tag type-tag">${item.type || 'Unknown'}</span>
                  ${item.feedback === 'positive' ?
                `<span class="tag positive">
                      <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M7 10v12"></path>
                        <path d="M15 5.88 14 10h5.83a2 2 0 0 1 1.92 2.56l-2.33 8A2 2 0 0 1 17.5 22H4a2 2 0 0 1-2-2v-8a2 2 0 0 1 2-2h2.76a2 2 0 0 0 1.79-1.11L12 2h0a3.13 3.13 0 0 1 3 3.88Z"></path>
                      </svg>
                      Positive
                    </span>` :
                ''
        }
                  ${item.feedback === 'negative' ?
                `<span class="tag negative">
                      <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M17 14V2"></path>
                        <path d="M9 18.12 10 14H4.17a2 2 0 0 1-1.92-2.56l2.33-8A2 2 0 0 1 6.5 2H20a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2h-2.76a2 2 0 0 0-1.79 1.11L12 22h0a3.13 3.13 0 0 1-3-3.88Z"></path>
                      </svg>
                      Negative
                    </span>` :
                ''
        }
                  ${item.hidden ?
                `<span class="tag archived">
                      <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-right: 4px;">
                        <rect width="20" height="5" x="2" y="3" rx="1"></rect>
                        <path d="M4 8v11a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8"></path>
                        <path d="M10 12h4"></path>
                      </svg>
                      Archived
                    </span>` :
                ''
        }
                </div>
                <h3 class="feedback-question">${item.question}</h3>
                <p class="feedback-query">User: ${item.userName || 'Unknown'}</p>
                <div class="feedback-meta">
                  <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
                  </svg>
                  ${item.conversation?.length || 0} messages
                </div>
              </div>
              <div class="feedback-actions">
                <button class="action-btn positive${item.feedback === 'positive' ? ' active' : ''}" data-action="positive" data-id="${item.id}" title="Pozitif olarak işaretle">
                  <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M7 10v12"></path>
                    <path d="M15 5.88 14 10h5.83a2 2 0 0 1 1.92 2.56l-2.33 8A2 2 0 0 1 17.5 22H4a2 2 0 0 1-2-2v-8a2 2 0 0 1 2-2h2.76a2 2 0 0 0 1.79-1.11L12 2h0a3.13 3.13 0 0 1 3 3.88Z"></path>
                  </svg>
                </button>
                <button class="action-btn negative${item.feedback === 'negative' ? ' active' : ''}" data-action="negative" data-id="${item.id}" title="Negatif olarak işaretle">
                  <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M17 14V2"></path>
                    <path d="M9 18.12 10 14H4.17a2 2 0 0 1-1.92-2.56l2.33-8A2 2 0 0 1 6.5 2H20a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2h-2.76a2 2 0 0 0-1.79 1.11L12 22h0a3.13 3.13 0 0 1-3-3.88Z"></path>
                  </svg>
                </button>
                <button class="action-btn archive${item.hidden ? ' active' : ''}" data-action="hidden" data-id="${item.id}" title="${item.hidden ? 'Restore item' : 'Arşivle'}">
                  <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <rect width="20" height="5" x="2" y="3" rx="1"></rect>
                    <path d="M4 8v11a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8"></path>
                    <path d="M10 12h4"></path>
                  </svg>
                </button>
              </div>
            </div>
          `;

        // Add click event to open conversation dialog
        itemElement.addEventListener('click', () => openDialog(item));

        // Add click events for action buttons
        const actionButtons = itemElement.querySelectorAll('.action-btn');
        actionButtons.forEach(button => {
          button.addEventListener('click', event => {
            event.stopPropagation();

            // Add click animation
            button.style.animation = 'pulse 0.5s';
            setTimeout(() => {
              button.style.animation = '';
            }, 500);

            const action = button.dataset.action;
            const id = button.dataset.id;

            if (action === 'positive') {
              handlePositiveFeedback(id);
            } else if (action === 'negative') {
              handleNegativeFeedback(id);
            } else if (action === 'hidden') {
              handleToggleHidden(id);
            }
          });
        });

        feedbackItems.appendChild(itemElement);

        // Animate the item in with a staggered delay
        setTimeout(() => {
          itemElement.style.opacity = '1';
          itemElement.style.transform = 'translateY(0)';
          itemElement.style.transitionProperty = 'opacity, transform';
          itemElement.style.transitionDuration = '0.3s';
          itemElement.style.transitionTimingFunction = 'ease-out';
          itemElement.style.transitionDelay = `${index * 50}ms`;
        }, 50);
      });
    }, existingItems.length > 0 ? 300 : 0);
  }

  // Handle positive feedback
  async function handlePositiveFeedback(id) {
    // Get the current item
    const item = data.find(item => item.id === id);

    // If already positive, remove feedback
    const newFeedback = item.feedback === 'positive' ? null : 'positive';

    // Show animation if adding feedback
    if (newFeedback === 'positive') {
      showFeedbackAnimation(id, 'positive');
    }

    // Update data locally first (for immediate UI response)
    data = data.map(item => {
      if (item.id === id) {
        return { ...item, feedback: newFeedback };
      }
      return item;
    });

    // Update MongoDB via API
    try {
      const response = await fetch(`${API_BASE_URL}/conversations/${id}/feedback`, {
        method: 'PATCH',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ feedback: newFeedback })
      });

      if (!response.ok) {
        console.error('Error updating feedback:', await response.text());
      }
    } catch (error) {
      console.error('Failed to update feedback:', error);
    }

    // Apply filters to update UI
    applyFilters();
  }

  // Handle negative feedback
  async function handleNegativeFeedback(id) {
    // Get the current item
    const item = data.find(item => item.id === id);

    // If already negative, remove feedback
    const newFeedback = item.feedback === 'negative' ? null : 'negative';

    // Show animation if adding feedback
    if (newFeedback === 'negative') {
      showFeedbackAnimation(id, 'negative');
    }

    // Update data locally first (for immediate UI response)
    data = data.map(item => {
      if (item.id === id) {
        return { ...item, feedback: newFeedback };
      }
      return item;
    });

    // Update MongoDB via API
    try {
      const response = await fetch(`${API_BASE_URL}/conversations/${id}/feedback`, {
        method: 'PATCH',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ feedback: newFeedback })
      });

      if (!response.ok) {
        console.error('Error updating feedback:', await response.text());
      }
    } catch (error) {
      console.error('Failed to update feedback:', error);
    }

    // Apply filters to update UI
    applyFilters();
  }

  // Handle toggle hidden
  async function handleToggleHidden(id) {
    // Get the current item
    const item = data.find(item => item.id === id);

    // Toggle hidden state
    const newHiddenState = !item.hidden;

    // Update data locally first (for immediate UI response)
    data = data.map(item => {
      if (item.id === id) {
        return { ...item, hidden: newHiddenState };
      }
      return item;
    });

    // Update MongoDB via API
    try {
      const response = await fetch(`${API_BASE_URL}/conversations/${id}/archive`, {
        method: 'PATCH',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ hidden: newHiddenState })
      });

      if (!response.ok) {
        console.error('Error updating archive status:', await response.text());
      }
    } catch (error) {
      console.error('Failed to update archive status:', error);
    }

    // Apply filters to update UI
    applyFilters();

    console.log(`Item ${id} archived state: ${newHiddenState}`);
  }

  // Show feedback animation with more visual effects
  function showFeedbackAnimation(id, type) {
    // Clear previous animation if exists
    if (activeAnimationId) {
      const prevOverlay = document.querySelector(`.animation-overlay[data-id="${activeAnimationId}"]`);
      if (prevOverlay) {
        prevOverlay.remove();
      }

      clearTimeout(animationTimeout);
    }

    // Set active animation id
    activeAnimationId = id;

    // Find item element
    const itemElement = document.querySelector(`.feedback-item[data-id="${id}"]`);
    if (!itemElement) return;

    // Add visual ripple effect
    const ripple = document.createElement('div');
    ripple.style.position = 'absolute';
    ripple.style.top = '50%';
    ripple.style.left = '50%';
    ripple.style.transform = 'translate(-50%, -50%)';
    ripple.style.width = '20px';
    ripple.style.height = '20px';
    ripple.style.borderRadius = '50%';
    ripple.style.backgroundColor = type === 'positive' ? 'rgba(16, 185, 129, 0.5)' : 'rgba(239, 68, 68, 0.5)';
    ripple.style.animation = 'ripple 0.8s ease-out forwards';

    // Add keyframes for ripple animation if not already added
    if (!document.querySelector('#ripple-animation')) {
      const style = document.createElement('style');
      style.id = 'ripple-animation';
      style.textContent = `
          @keyframes ripple {
            0% { width: 20px; height: 20px; opacity: 1; }
            100% { width: 400px; height: 400px; opacity: 0; }
          }
        `;
      document.head.appendChild(style);
    }

    // Create animation overlay
    const overlay = document.createElement('div');
    overlay.className = `animation-overlay ${type}`;
    overlay.dataset.id = id;
    overlay.style.position = 'absolute';
    overlay.style.inset = '0';
    overlay.style.display = 'flex';
    overlay.style.alignItems = 'center';
    overlay.style.justifyContent = 'center';
    overlay.style.borderRadius = '0.5rem';
    overlay.style.backgroundColor = type === 'positive' ? 'rgba(16, 185, 129, 0.3)' : 'rgba(239, 68, 68, 0.3)';
    overlay.style.animation = 'fadeIn 0.3s ease-out';

    // Create animation icon
    const icon = document.createElement('div');
    icon.className = `animation-icon ${type}`;
    icon.style.width = '4rem';
    icon.style.height = '4rem';
    icon.style.color = type === 'positive' ? '#10b981' : '#ef4444';
    icon.style.animation = 'pulse 1s infinite';

    // Add icon SVG
    if (type === 'positive') {
      icon.innerHTML = `
          <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M7 10v12"></path>
            <path d="M15 5.88 14 10h5.83a2 2 0 0 1 1.92 2.56l-2.33 8A2 2 0 0 1 17.5 22H4a2 2 0 0 1-2-2v-8a2 2 0 0 1 2-2h2.76a2 2 0 0 0 1.79-1.11L12 2h0a3.13 3.13 0 0 1 3 3.88Z"></path>
          </svg>
        `;
    } else {
      icon.innerHTML = `
          <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M17 14V2"></path>
            <path d="M9 18.12 10 14H4.17a2 2 0 0 1-1.92-2.56l2.33-8A2 2 0 0 1 6.5 2H20a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2h-2.76a2 2 0 0 0-1.79 1.11L12 22h0a3.13 3.13 0 0 1-3-3.88Z"></path>
          </svg>
        `;
    }

    // Add ripple effect first
    itemElement.style.position = 'relative';
    itemElement.appendChild(ripple);

    // Then add icon to overlay
    overlay.appendChild(icon);

    // Add overlay to item after a small delay
    setTimeout(() => {
      itemElement.appendChild(overlay);
    }, 200);

    // Add a brief "shake" animation to the item
    itemElement.style.animation = type === 'positive' ? 'shake 0.5s ease' : 'shake 0.5s ease';

    // Remove overlay and effects after animation
    animationTimeout = setTimeout(() => {
      if (overlay.parentNode === itemElement) {
        // Fade out animation
        overlay.style.animation = 'fadeOut 0.3s ease-out forwards';

        // Remove after fade out
        setTimeout(() => {
          if (overlay.parentNode === itemElement) {
            overlay.remove();
          }
          if (ripple.parentNode === itemElement) {
            ripple.remove();
          }
          itemElement.style.animation = '';
        }, 300);
      }
      activeAnimationId = null;
    }, 1000);
  }

  // Open conversation dialog with animation
  function openDialog(item) {
    // Set current item ID
    currentItemId = item.id;

    // Set dialog title
    dialogTitle.innerHTML = `
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
        </svg>
        ${item.question}
      `;

    // Clear dialog content
    dialogContent.innerHTML = '';

    // Update schema buttons
    updateSchemaButtons(item.schema);

    // Hide edit container
    editMessageContainer.classList.add('hidden');

    // Show dialog with animation
    dialogBackdrop.classList.remove('hidden');
    dialogBackdrop.style.backgroundColor = 'rgba(0, 0, 0, 0)';
    dialog.style.transform = 'scale(0.9)';
    dialog.style.opacity = '0';

    // Animate dialog in
    setTimeout(() => {
      dialogBackdrop.style.backgroundColor = 'rgba(0, 0, 0, 0.5)';
      dialog.style.transform = 'scale(1)';
      dialog.style.opacity = '1';
    }, 10);

    // Add conversation items with staggered animation
    if (item.conversation && item.conversation.length > 0) {
      item.conversation.forEach((message, index) => {
        const messageElement = document.createElement('div');
        messageElement.className = `conversation-item ${message.role}`;

        messageElement.innerHTML = `
            <div class="conversation-bubble">
              <p class="conversation-role">${message.role === 'user' ? 'User' : 'Assistant'}</p>
              <p>${message.message}</p>
            </div>
          `;

        dialogContent.appendChild(messageElement);
      });

      // Scroll to bottom
      setTimeout(() => {
        dialogContent.scrollTop = dialogContent.scrollHeight;
      }, 300);
    }
  }

  // Update schema buttons based on selected schema
  function updateSchemaButtons(selectedSchema) {
    schemaButtons.forEach(button => {
      const schema = button.dataset.schema;
      button.classList.toggle('active', schema === selectedSchema);

      // Add click event
      button.onclick = () => setSchema(currentItemId, schema);
    });
  }

  // Set schema for an item
  async function setSchema(id, schema) {
    const item = data.find(item => item.id === id);

    if (item) {
      // Update schema locally first
      const oldSchema = item.schema;
      item.schema = schema;

      // Update schema buttons
      updateSchemaButtons(schema);

      // Update MongoDB via API
      try {
        const response = await fetch(`${API_BASE_URL}/conversations/${id}/schema`, {
          method: 'PATCH',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ schema })
        });

        if (!response.ok) {
          console.error('Error updating schema:', await response.text());
          // Revert to old schema if update failed
          item.schema = oldSchema;
          updateSchemaButtons(oldSchema);
          alert('Failed to update schema on server. Please try again.');
          return;
        }

        // Show success notification
        showNotification(`Schema updated to "${schema}"`, 'success');

        // Refresh items
        applyFilters();
      } catch (error) {
        console.error('Failed to update schema:', error);
        // Revert to old schema if update failed
        item.schema = oldSchema;
        updateSchemaButtons(oldSchema);
        alert('Failed to update schema: ' + error.message);
      }
    }
  }

  // Show notification
  function showNotification(message, type = 'info') {
    const notification = document.createElement('div');
    notification.className = `notification ${type}`;
    notification.textContent = message;

    document.body.appendChild(notification);

    // Animate in
    setTimeout(() => {
      notification.style.transform = 'translateX(0)';
      notification.style.opacity = '1';
    }, 10);

    // Automatically remove after 3 seconds
    setTimeout(() => {
      notification.style.transform = 'translateX(100%)';
      notification.style.opacity = '0';

      // Remove from DOM after animation
      setTimeout(() => {
        notification.remove();
      }, 300);
    }, 3000);
  }

  // Close conversation dialog with animation
  function closeDialog() {
    // Animate dialog out
    dialog.style.transform = 'scale(0.9)';
    dialog.style.opacity = '0';
    dialogBackdrop.style.backgroundColor = 'rgba(0, 0, 0, 0)';

    // Hide dialog after animation
    setTimeout(() => {
      dialogBackdrop.classList.add('hidden');
      dialog.style.transform = '';
      dialog.style.opacity = '';
      currentItemId = null;
    }, 300);
  }

  // Start the app
  connectToMongoDB();
</script>
<script src="feedback-system-fixes.js"></script>
<script src="feedback-system-fixes-2.js"></script>
<script src="similarity-fix.js"></script>
<!-- Similar Conversations Feature -->
<div id="similar-dialog-backdrop" class="dialog-backdrop hidden">
  <div id="similar-dialog" class="dialog">
    <div class="dialog-header">
      <h3 id="similar-dialog-title" class="dialog-title">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <circle cx="11" cy="11" r="8"></circle>
          <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
        </svg>
        Similar Conversations
      </h3>
      <button id="similar-dialog-close" class="dialog-close">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <circle cx="12" cy="12" r="10"></circle>
          <line x1="15" y1="9" x2="9" y2="15"></line>
          <line x1="9" y1="9" x2="15" y2="15"></line>
        </svg>
      </button>
    </div>
    <div id="similar-dialog-content" class="dialog-content">
      <div id="similar-search-container" class="search-container">
        <svg class="search-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <circle cx="11" cy="11" r="8"></circle>
          <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
        </svg>
        <input type="text" id="similar-search-input" class="search-input" placeholder="Search for similar questions or queries...">
        <button id="similar-search-button" class="edit-btn" style="margin-top: 0.5rem;">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <circle cx="11" cy="11" r="8"></circle>
            <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
          </svg>
          Search Similar
        </button>
      </div>

      <div id="similar-items" class="feedback-items" style="margin-top: 1rem;"></div>
      <div id="no-similar-results" class="no-results hidden">
        No similar questions found
      </div>
    </div>
  </div>
</div>

<!-- Add a Similar Search Button in the Dialog Controls -->
<script>
  // Add the similar search button to the dialog controls after page load
  document.addEventListener('DOMContentLoaded', function() {
    const dialogControls = document.querySelector('.dialog-controls');
    if (dialogControls) {
      const similarButton = document.createElement('button');
      similarButton.id = 'find-similar-btn';
      similarButton.className = 'edit-btn';
      similarButton.innerHTML = `
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <circle cx="11" cy="11" r="8"></circle>
          <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
        </svg>
        Find Similar
      `;

      dialogControls.appendChild(similarButton);

      // Add click event for the similar button
      similarButton.addEventListener('click', () => {
        openSimilarDialog();
      });
    }

    // Similar dialog close button
    const similarDialogClose = document.getElementById('similar-dialog-close');
    const similarDialogBackdrop = document.getElementById('similar-dialog-backdrop');

    if (similarDialogClose) {
      similarDialogClose.addEventListener('click', closeSimilarDialog);
    }

    if (similarDialogBackdrop) {
      similarDialogBackdrop.addEventListener('click', event => {
        if (event.target === similarDialogBackdrop) {
          closeSimilarDialog();
        }
      });
    }

    // Similar search button
    const similarSearchButton = document.getElementById('similar-search-button');
    if (similarSearchButton) {
      similarSearchButton.addEventListener('click', () => {
        const query = document.getElementById('similar-search-input').value;
        if (query) {
          searchSimilarConversations(query);
        }
      });
    }

    // Add keypress event to search input
    const similarSearchInput = document.getElementById('similar-search-input');
    if (similarSearchInput) {
      similarSearchInput.addEventListener('keypress', event => {
        if (event.key === 'Enter') {
          const query = similarSearchInput.value;
          if (query) {
            searchSimilarConversations(query);
          }
        }
      });
    }
  });

  // Functions for similar dialog
  function openSimilarDialog() {
    const item = data.find(item => item.id === currentItemId);
    if (!item) return;

    const similarDialogBackdrop = document.getElementById('similar-dialog-backdrop');
    const similarDialog = document.getElementById('similar-dialog');
    const similarSearchInput = document.getElementById('similar-search-input');

    if (!similarDialogBackdrop || !similarDialog) return;

    // Set search input to current question
    if (similarSearchInput) {
      similarSearchInput.value = item.question;
    }

    // Clear previous results
    const similarItems = document.getElementById('similar-items');
    if (similarItems) {
      similarItems.innerHTML = '';
    }

    // Show dialog with animation
    similarDialogBackdrop.classList.remove('hidden');
    similarDialogBackdrop.style.backgroundColor = 'rgba(0, 0, 0, 0)';
    similarDialog.style.transform = 'scale(0.9)';
    similarDialog.style.opacity = '0';

    // Animate dialog in
    setTimeout(() => {
      similarDialogBackdrop.style.backgroundColor = 'rgba(0, 0, 0, 0.5)';
      similarDialog.style.transform = 'scale(1)';
      similarDialog.style.opacity = '1';

      // Auto search on open if there's a question
      if (similarSearchInput && similarSearchInput.value) {
        searchSimilarConversations(similarSearchInput.value);
      }
    }, 10);
  }

  function closeSimilarDialog() {
    const similarDialogBackdrop = document.getElementById('similar-dialog-backdrop');
    const similarDialog = document.getElementById('similar-dialog');

    if (!similarDialogBackdrop || !similarDialog) return;

    // Animate dialog out
    similarDialog.style.transform = 'scale(0.9)';
    similarDialog.style.opacity = '0';
    similarDialogBackdrop.style.backgroundColor = 'rgba(0, 0, 0, 0)';

    // Hide dialog after animation
    setTimeout(() => {
      similarDialogBackdrop.classList.add('hidden');
      similarDialog.style.transform = '';
      similarDialog.style.opacity = '';
    }, 300);
  }

  async function searchSimilarConversations(query) {
    const similarItems = document.getElementById('similar-items');
    const noSimilarResults = document.getElementById('no-similar-results');

    if (!similarItems || !noSimilarResults) return;

    // Show loading indicator
    similarItems.innerHTML = '<div class="loading">Searching for similar conversations...</div>';
    noSimilarResults.classList.add('hidden');

    try {
      // Get active filters
      const schema = activeSchema || '';
      const type = activeTypeFilter || '';

      // Build query parameters
      const params = new URLSearchParams();
      params.append('query', query);
      if (schema) params.append('schema', schema);
      if (type) params.append('type', type);
      params.append('limit', 10);

      // Fetch similar conversations
      const response = await fetch(`${API_BASE_URL}/similar-conversations?${params.toString()}`);

      if (!response.ok) {
        throw new Error(`API responded with status: ${response.status}`);
      }

      const results = await response.json();

      // Clear loading indicator
      similarItems.innerHTML = '';

      // Display results or show no results message
      if (results && results.length > 0) {
        results.forEach(result => {
          const similarityPercentage = Math.round(result.score * 100);

          const itemElement = document.createElement('div');
          itemElement.className = `feedback-item${result.hidden ? ' hidden' : ''}${result.feedback === 'positive' ? ' positive' : result.feedback === 'negative' ? ' negative' : ''}`;
          itemElement.dataset.id = result.id;

          // Create item content
          itemElement.innerHTML = `
            <div class="feedback-header">
              <div class="feedback-content">
                <div class="feedback-tags">
                  ${result.schema ? `<span class="tag">${result.schema}</span>` : ''}
                  <span class="tag type-tag">${result.type || 'Unknown'}</span>
                  <span class="tag" style="background-color: #2563eb;">
                    <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                      <path d="M18 10h-1.26A8 8 0 1 0 9 20h9a5 5 0 0 0 0-10z"></path>
                    </svg>
                    ${similarityPercentage}% Similar
                  </span>
                </div>
                <h3 class="feedback-question">${result.question}</h3>
                <p class="feedback-query">User: ${result.userName || 'Unknown'}</p>
              </div>
            </div>
          `;

          // Add click event to open conversation
          itemElement.addEventListener('click', () => {
            // Close similar dialog
            closeSimilarDialog();

            // Find the full conversation from data or fetch it
            const existingItem = data.find(item => item.id === result.id);
            if (existingItem) {
              openDialog(existingItem);
            } else {
              // Fetch the conversation if not in current data
              fetchAndOpenConversation(result.id);
            }
          });

          similarItems.appendChild(itemElement);
        });

        noSimilarResults.classList.add('hidden');
      } else {
        similarItems.innerHTML = '';
        noSimilarResults.classList.remove('hidden');
      }
    } catch (error) {
      console.error('Error searching similar conversations:', error);
      similarItems.innerHTML = `<div class="error">Error searching: ${error.message}</div>`;
    }
  }

  async function fetchAndOpenConversation(id) {
    try {
      const response = await fetch(`${API_BASE_URL}/conversations/${id}`);

      if (!response.ok) {
        throw new Error(`API responded with status: ${response.status}`);
      }

      const conversation = await response.json();

      // Convert to app format
      const formattedConversation = {
        id: conversation._id.$oid || conversation._id || conversation.id,
        schema: conversation.schema || '',
        question: extractQuestionFromConversation(conversation),
        query: extractQuestionFromConversation(conversation),
        feedback: conversation.feedback || null,
        hidden: conversation.hidden || false,
        conversation: parseMessages(conversation.messages),
        timestamp: conversation.timestamp || '',
        type: conversation.type || 'Unknown',
        userName: conversation.userName || '',
        originalData: conversation
      };

      // Open the dialog
      openDialog(formattedConversation);
    } catch (error) {
      console.error('Error fetching conversation:', error);
      alert(`Error fetching conversation: ${error.message}`);
    }
  }

  function extractQuestionFromConversation(conversation) {
    try {
      if (!conversation.messages) return 'No messages';

      const parsedMessages = parseMessages(conversation.messages);
      const firstUserMessage = parsedMessages.find(msg => msg.role === 'user');
      return firstUserMessage ? firstUserMessage.message : 'No question found';
    } catch (error) {
      console.error('Error extracting question:', error);
      return 'Error extracting question';
    }
  }
</script>

<!-- Add this style section at the end of your existing styles -->
<style>
  /* Similar dialog styles */
  .loading {
    text-align: center;
    padding: 2rem 0;
    color: #9ca3af;
  }

  .error {
    text-align: center;
    padding: 1rem;
    color: #ef4444;
    background-color: rgba(239, 68, 68, 0.1);
    border-radius: 0.5rem;
    margin: 1rem 0;
  }

  /* Similar button animation */
  #find-similar-btn:hover svg {
    animation: pulse 1s infinite;
  }
</style>
</body>
</html>

