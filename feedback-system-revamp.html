<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AI Chatbot Feedback System</title>
  <style>
    /* General styles */
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
      background-color: #111827;
      color: #f3f4f6;
      line-height: 1.5;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 1rem;
    }

    h1 {
      font-size: 1.5rem;
      font-weight: bold;
      margin-bottom: 1.5rem;
    }

    /* Search bar */
    .search-container {
      position: relative;
      margin-bottom: 1.5rem;
    }

    .search-icon {
      position: absolute;
      left: 0.75rem;
      top: 50%;
      transform: translateY(-50%);
      color: #9ca3af;
    }

    .search-input {
      width: 100%;
      padding: 0.625rem 0.75rem 0.625rem 2.5rem;
      background-color: #1f2937;
      border: 1px solid #374151;
      border-radius: 0.5rem;
      color: #f3f4f6;
      font-size: 0.875rem;
    }

    .search-input:focus {
      outline: none;
      border-color: #3b82f6;
      box-shadow: 0 0 0 1px #3b82f6;
    }

    /* Filter styles */
    .filter-section {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      margin-bottom: 1.5rem;
    }

    .filter-label {
      display: flex;
      align-items: center;
      margin-right: 0.5rem;
    }

    .filter-label svg {
      margin-right: 0.25rem;
    }

    .filter-buttons {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
    }

    .filter-btn {
      padding: 0.25rem 0.75rem;
      border-radius: 9999px;
      font-size: 0.875rem;
      background-color: #1f2937;
      color: #d1d5db;
      border: none;
      cursor: pointer;
      transition: background-color 0.2s;
      display: flex;
      align-items: center;
      gap: 0.25rem;
    }

    .filter-btn:hover {
      background-color: #374151;
    }

    .filter-btn.active {
      background-color: #2563eb;
      color: white;
    }

    /* Feedback filters */
    .feedback-filters {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      margin-bottom: 1.5rem;
      border-top: 1px solid #374151;
      padding-top: 1rem;
    }

    /* Page size buttons */
    .page-size {
      display: flex;
      gap: 0.5rem;
      margin-bottom: 1.5rem;
      align-items: center;
    }

    .page-size-btn {
      padding: 0.25rem 0.75rem;
      border-radius: 0.25rem;
      font-size: 0.875rem;
      background-color: #1f2937;
      color: #d1d5db;
      border: none;
      cursor: pointer;
    }

    .page-size-btn.active {
      background-color: #374151;
      color: white;
    }

    /* Results count */
    .results-count {
      margin-bottom: 1rem;
      color: #9ca3af;
      font-size: 0.875rem;
    }

    /* Content with formatting support */
    .conversation-content, .cypher-query, .suggestion-list li {
      white-space: pre-wrap;
      word-wrap: break-word;
      line-height: 1.5;
    }

    /* Table styling for conversations */
    .conversation-table {
      border-collapse: collapse;
      width: 100%;
      margin: 1rem 0;
      font-size: 0.9rem;
    }

    .conversation-table td {
      border: 1px solid #374151;
      padding: 0.5rem;
      text-align: left;
    }

    /* Cypher query styling */
    .cypher-query {
      background-color: #2d3748;
      padding: 0.75rem;
      border-radius: 0.25rem;
      margin-bottom: 1rem;
      font-family: monospace;
      font-size: 0.9rem;
      overflow-x: auto;
    }

    /* Enhance the suggestion list */
    .suggestion-list li {
      padding: 0.75rem;
      background-color: #374151;
      border-radius: 0.5rem;
      margin-bottom: 0.75rem;
    }
    /* Additional data buttons styles */
    .additional-data-buttons {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      margin-top: 0.5rem;
    }

    .data-btn {
      display: flex;
      align-items: center;
      gap: 0.25rem;
      padding: 0.4rem 0.6rem;
      background-color: #2d3748;
      color: #d1d5db;
      border: none;
      border-radius: 0.375rem;
      font-size: 0.75rem;
      cursor: pointer;
      transition: background-color 0.2s, transform 0.2s;
    }

    .data-btn:hover:not(:disabled) {
      background-color: #4a5568;
      transform: translateY(-1px);
    }

    .data-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .data-btn svg {
      width: 14px;
      height: 14px;
    }

    /* Data popup styles */
    .data-popup {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.75);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 100;
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.3s ease, visibility 0.3s ease;
    }

    .data-popup.active {
      opacity: 1;
      visibility: visible;
    }

    .popup-content {
      background-color: #1f2937;
      border-radius: 0.5rem;
      width: 90%;
      max-width: 900px;
      max-height: 90vh;
      display: flex;
      flex-direction: column;
      box-shadow: 0 10px 15px rgba(0, 0, 0, 0.5);
      transform: scale(0.9);
      transition: transform 0.3s ease;
    }

    .data-popup.active .popup-content {
      transform: scale(1);
    }

    .popup-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 1rem;
      border-bottom: 1px solid #374151;
    }

    .popup-header h3 {
      margin: 0;
      font-size: 1.25rem;
      font-weight: 500;
    }

    .popup-close {
      background: none;
      border: none;
      color: #9ca3af;
      cursor: pointer;
      padding: 0.25rem;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 0.25rem;
      transition: background-color 0.2s;
    }

    .popup-close:hover {
      background-color: #374151;
    }

    .popup-body {
      padding: 1rem;
      overflow-y: auto;
      flex: 1;
    }

    .popup-body pre {
      white-space: pre-wrap;
      word-wrap: break-word;
      font-family: monospace;
      font-size: 0.9rem;
      line-height: 1.5;
      color: #d1d5db;
      margin: 0;
      padding: 0.5rem;
      background-color: #2d3748;
      border-radius: 0.25rem;
      overflow-x: auto;
    }

    /* MongoDB Connection Styles */
    .connection-status {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      margin-bottom: 1rem;
      font-size: 0.875rem;
    }

    .connection-status .status-indicator {
      width: 0.75rem;
      height: 0.75rem;
      border-radius: 50%;
      background-color: #9ca3af;
    }

    .connection-status .status-indicator.connected {
      background-color: #10b981;
    }

    .connection-status .status-indicator.disconnected {
      background-color: #ef4444;
    }

    /* Feedback items */
    .feedback-items {
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }

    .feedback-item {
      position: relative;
      display: flex;
      border-radius: 0.5rem;
      background-color: #1f2937;
      overflow: hidden;
      animation: fadeIn 0.3s ease-out;
      transition: all 0.3s ease;
    }

    /* Schema buttons on the left */
    .schema-buttons {
      display: flex;
      flex-direction: column;
      padding: 1rem;
      background-color: #1f2937;
      border-right: 1px solid #374151;
      min-width: 120px;
      justify-content: center;
      align-items: center;
      gap: 0.5rem;
    }

    .schema-btn {
      display: block;
      width: 100%;
      padding: 0.5rem;
      border-radius: 0.5rem;
      background-color: #1f2937;
      color: #d1d5db;
      border: 1px solid #374151;
      cursor: pointer;
      transition: all 0.2s ease;
      text-align: center;
    }

    .schema-btn:hover {
      background-color: #2d3748;
    }

    .schema-btn.active {
      background-color: #2563eb;
      color: white;
      border-color: #2563eb;
    }

    /* Content buttons in the middle */
    .feedback-content {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
      padding: 1rem;
    }

    /* User info at top */
    .feedback-user-info {
      display: flex;
      justify-content: space-between;
      font-size: 0.8rem;
      color: #9ca3af;
      border-bottom: 1px solid #374151;
      padding-bottom: 0.5rem;
    }

    .user-name {
      font-weight: 500;
    }

    .datetime {
      font-style: italic;
    }

    /* Conversation and action buttons */
    .feedback-buttons {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }

    .conversation-btn {
      width: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 1rem;
      background-color: #374151;
      border: none;
      border-radius: 0.5rem;
      color: white;
      font-size: 1rem;
      text-align: left;
      cursor: pointer;
      transition: background-color 0.2s;
      min-height: 60px;
    }

    .conversation-btn:hover {
      background-color: #4b5563;
    }

    .small-buttons {
      display: flex;
      gap: 0.5rem;
      width: 100%;
    }

    .suggestion-btn, .cypher-btn {
      flex: 1;
      padding: 0.5rem;
      background-color: #374151;
      border: none;
      border-radius: 0.5rem;
      color: white;
      font-size: 0.875rem;
      cursor: pointer;
      transition: background-color 0.2s;
    }

    .suggestion-btn:hover, .cypher-btn:hover {
      background-color: #4b5563;
    }

    /* Feedback actions on the right */
    .feedback-actions {
      display: flex;
      flex-direction: column;
      padding: 1rem;
      background-color: #1f2937;
      border-left: 1px solid #374151;
      justify-content: center;
      gap: 1rem;
    }

    .action-btn {
      padding: 0.5rem;
      border-radius: 50%;
      border: none;
      cursor: pointer;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      width: 40px;
      height: 40px;
    }

    .action-btn:hover {
      transform: scale(1.1);
    }

    .action-btn svg {
      width: 20px;
      height: 20px;
    }

    .action-btn.positive {
      background-color: #10b981; /* Green */
      color: white;
    }

    .action-btn.positive:hover {
      background-color: #059669; /* Brighter green */
    }

    .action-btn.archive {
      background-color: #f59e0b; /* Yellow */
      color: white;
    }

    .action-btn.archive:hover {
      background-color: #d97706; /* Brighter yellow */
    }

    .action-btn.negative {
      background-color: #ef4444; /* Red */
      color: white;
    }

    .action-btn.negative:hover {
      background-color: #dc2626; /* Brighter red */
    }

    /* Modal styles for content popup */
    .modal-backdrop {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.7);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 50;
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.3s ease, visibility 0.3s ease;
    }

    .modal-backdrop.active {
      opacity: 1;
      visibility: visible;
    }

    .modal-content {
      background-color: #1f2937;
      border-radius: 0.5rem;
      width: 90%;
      max-width: 900px;
      max-height: 90vh;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      transform: scale(0.9);
      transition: transform 0.3s ease;
    }

    .modal-backdrop.active .modal-content {
      transform: scale(1);
    }

    .modal-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 1rem;
      border-bottom: 1px solid #374151;
    }

    .modal-title {
      font-size: 1.2rem;
      font-weight: 500;
    }

    .modal-close {
      background: none;
      border: none;
      color: #9ca3af;
      cursor: pointer;
      padding: 0.5rem;
    }

    .modal-body {
      flex: 1;
      padding: 1rem;
      overflow-y: auto;
    }

    /* User info in modal */
    .user-info {
      display: flex;
      justify-content: space-between;
      padding: 0.5rem 0;
      font-size: 0.875rem;
      color: #9ca3af;
      margin-bottom: 0.5rem;
    }

    /* Conversation Tab */
    .conversation-item {
      margin-bottom: 1rem;
    }

    .conversation-item.user {
      text-align: right;
    }

    .conversation-item.assistant {
      text-align: left;
    }

    .conversation-bubble {
      display: inline-block;
      max-width: 80%;
      padding: 0.75rem;
      border-radius: 0.5rem;
      white-space: pre-line;
    }

    .conversation-item.user .conversation-bubble {
      background-color: #2563eb;
      color: white;
      border-top-right-radius: 0;
    }

    .conversation-item.assistant .conversation-bubble {
      background-color: #374151;
      color: white;
      border-top-left-radius: 0;
    }

    .conversation-role {
      font-size: 0.875rem;
      font-weight: 500;
      margin-bottom: 0.25rem;
      opacity: 0.7;
    }

    /* Suggestion and Cypher Query Tabs */
    .suggestion-list, .cypher-list {
      list-style-type: none;
      padding-left: 0;
    }

    .suggestion-list li, .cypher-list li {
      padding: 0.75rem;
      background-color: #374151;
      border-radius: 0.5rem;
      margin-bottom: 0.75rem;
      word-wrap: break-word;
      white-space: pre-wrap;
    }

    /* Tabs Navigation */
    .tabs-container {
      margin-bottom: 1rem;
    }

    .tabs-header {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      margin-bottom: 1rem;
    }

    .tabs-list {
      display: flex;
      gap: 0.25rem;
      overflow-x: auto;
      scrollbar-width: thin;
      padding: 0.25rem 0;
      flex-grow: 1;
    }

    .tab-nav-btn {
      padding: 0.5rem 0.75rem;
      background-color: #1f2937;
      color: #d1d5db;
      border: none;
      border-radius: 0.25rem;
      cursor: pointer;
      white-space: nowrap;
      transition: all 0.2s ease;
      flex-shrink: 0;
    }

    .tab-nav-btn:hover {
      background-color: #374151;
    }

    .tab-nav-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .pagination-btn {
      padding: 0.5rem 0.75rem;
      background-color: #1f2937;
      color: #d1d5db;
      border: none;
      border-radius: 0.25rem;
      cursor: pointer;
    }

    .pagination-btn.active {
      background-color: #2563eb;
      color: white;
    }

    /* No results */
    .no-results {
      text-align: center;
      padding: 2.5rem 0;
      color: #9ca3af;
    }
    /* Hide user info in modal */
    #modal-user-info {
      display: none;
    } 

    /* Animations and keyframes */
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    @keyframes pulse {
      0% { transform: scale(0.95); opacity: 0.8; }
      70% { transform: scale(1.1); opacity: 1; }
      100% { transform: scale(0.95); opacity: 0.8; }
    }

    .hidden {
      display: none;
    }

    .loading {
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 2rem;
      color: #9ca3af;
    }

    .loading::before {
      content: "";
      width: 20px;
      height: 20px;
      margin-right: 10px;
      border-radius: 50%;
      border: 2px solid #9ca3af;
      border-top-color: #3b82f6;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
<div class="container">
  <h1>Mürşit Feedback Sistemi</h1>

  <!-- MongoDB Connection Status -->
  <div class="connection-status">
    <div id="connection-indicator" class="status-indicator"></div>
    <span id="connection-text">Connecting to MongoDB...</span>
  </div>

  <!-- Search Bar -->
  <div class="search-container">
    <svg class="search-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <circle cx="11" cy="11" r="8"></circle>
      <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
    </svg>
    <input type="text" id="search-input" class="search-input" placeholder="Search questions or queries...">
  </div>

  <!-- Schema Filter Buttons -->
  <div class="filter-section">
    <div class="filter-label">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"></polygon>
      </svg>
      <span>Şema Filtreleri:</span>
    </div>
    <div id="schema-filters" class="filter-buttons">
      <button data-schema="Mesai" class="filter-btn">Mesai</button>
      <button data-schema="Mukavele" class="filter-btn">Mukavele</button>
      <button data-schema="Genel" class="filter-btn">Genel</button>
    </div>
  </div>

  <!-- Feedback Filter Buttons -->
  <div class="feedback-filters">
    <div class="filter-label">
      <span>Feedback Filtreleri:</span>
    </div>
    <button id="positive-filter" class="filter-btn">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="display: inline; margin-right: 4px;">
        <path d="M7 10v12"></path>
        <path d="M15 5.88 14 10h5.83a2 2 0 0 1 1.92 2.56l-2.33 8A2 2 0 0 1 17.5 22H4a2 2 0 0 1-2-2v-8a2 2 0 0 1 2-2h2.76a2 2 0 0 0 1.79-1.11L12 2h0a3.13 3.13 0 0 1 3 3.88Z"></path>
      </svg>
      Positive
    </button>
    <button id="negative-filter" class="filter-btn">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="display: inline; margin-right: 4px;">
        <path d="M17 14V2"></path>
        <path d="M9 18.12 10 14H4.17a2 2 0 0 1-1.92-2.56l2.33-8A2 2 0 0 1 6.5 2H20a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2h-2.76a2 2 0 0 0-1.79 1.11L12 22h0a3.13 3.13 0 0 1-3-3.88Z"></path>
      </svg>
      Negative
    </button>
    <button id="hidden-filter" class="filter-btn">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="display: inline; margin-right: 4px;">
        <rect width="20" height="5" x="2" y="3" rx="1"></rect>
        <path d="M4 8v11a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8"></path>
        <path d="M10 12h4"></path>
      </svg>
      Show Archived
    </button>
  </div>

  <!-- Page Size Selection -->
  <div class="page-size">
    <span>Gösterilecek:</span>
    <button data-size="20" class="page-size-btn active">20</button>
    <button data-size="40" class="page-size-btn">40</button>
    <button data-size="100" class="page-size-btn">100</button>
    <button data-size="200" class="page-size-btn">200</button>
  </div>

  <!-- Tabs Navigation -->
  <div id="tabs-container" class="tabs-container">
    <div class="tabs-header">
      <button id="prev-tab-btn" class="tab-nav-btn">&laquo; Previous</button>
      <div id="tabs-list" class="tabs-list"></div>
      <button id="next-tab-btn" class="tab-nav-btn">Next &raquo;</button>
    </div>
  </div>

  <!-- Results count -->
  <div id="results-count" class="results-count"></div>

  <!-- Feedback Items -->
  <div id="feedback-items" class="feedback-items"></div>

  <!-- No results message -->
  <div id="no-results" class="no-results hidden">
    No questions found matching your criteria
  </div>
</div>

<!-- Modal for viewing feedback content -->
<div id="feedback-modal" class="modal-backdrop">
  <div class="modal-content">
    <div class="modal-header">
      <div class="modal-title" id="modal-title">Feedback Details</div>
      <button class="modal-close" id="modal-close">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <line x1="18" y1="6" x2="6" y2="18"></line>
          <line x1="6" y1="6" x2="18" y2="18"></line>
        </svg>
      </button>
    </div>
    <div class="user-info" id="modal-user-info">
      <span id="modal-username">User: username</span>
      <span id="modal-datetime">Date: YYYY-MM-DD HH:MM</span>
    </div>
    <div class="modal-body" id="modal-body">
      <!-- Content will be dynamically inserted here -->
    </div>
  </div>
</div>

<script>
  // MongoDB API config
  const API_BASE_URL = "http://localhost:3000/api"; // Change this to your deployed API URL in production

  // App state
  let data = [];
  let filteredData = [];
  let activeSchema = null;
  let activeFeedbackFilter = null;
  let showHidden = false;
  let pageSize = 20;
  let searchQuery = '';
  let activeAnimationId = null;
  let animationTimeout = null;
  let currentItemId = null;
  let schemaList = ["Mesai", "Mukavele", "Genel"];
  let currentPage = 0;
  let totalPages = 0;
  let visibleTabCount = 5; // Number of tabs to show at once

  // Function to format date in a user-friendly way
  function formatDateTime(dateStr) {
    // If it's already a well-formatted date, return it
    if (/\d{1,2}\/\d{1,2}\/\d{4}, \d{1,2}:\d{2}:\d{2}/.test(dateStr)) {
      return dateStr;
    }

    let date;

    // Try to parse the date string
    if (typeof dateStr === 'string') {
      // Handle ISO format
      if (/^\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}/.test(dateStr)) {
        date = new Date(dateStr);
      }
      // Handle Unix timestamp (seconds)
      else if (/^\d{10}$/.test(dateStr)) {
        date = new Date(parseInt(dateStr) * 1000);
      }
      // Handle Unix timestamp (milliseconds)
      else if (/^\d{13}$/.test(dateStr)) {
        date = new Date(parseInt(dateStr));
      }
      // Try general parsing as a fallback
      else {
        date = new Date(dateStr);
      }
    } else if (dateStr instanceof Date) {
      date = dateStr;
    } else {
      return "Invalid date";
    }

    // Check if the date is valid
    if (isNaN(date.getTime())) {
      return "Invalid date";
    }

    // Format the date in a user-friendly way
    const options = {
      year: 'numeric',
      month: 'short',
      day: 'numeric',
      hour: '2-digit',
      minute: '2-digit'
    };

    return date.toLocaleDateString(undefined, options);
  }

  // Helper function to render formatted content
  // Helper function to render formatted content with better HTML handling
  function renderFormattedContent(text) {
    if (!text) return '';

    // Check if content is HTML (contains tags)
    if (text.includes('<') && text.includes('>')) {
      // This is likely HTML content, return it directly to be rendered as HTML
      return text;
    }

    // Regular formatting for non-HTML content
    // Replace newlines with <br>
    let formattedText = text.replace(/\n/g, '<br>');

    // Handle bold text (** or __)
    formattedText = formattedText.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
    formattedText = formattedText.replace(/__(.*?)__/g, '<strong>$1</strong>');

    // Handle table formatting if text contains pipe characters
    if (formattedText.includes('|')) {
      const lines = formattedText.split('<br>');
      let inTable = false;
      let tableContent = '';
      let processedLines = [];

      for (let line of lines) {
        // Check if line looks like a table row
        if (line.trim().startsWith('|') && line.trim().endsWith('|')) {
          if (!inTable) {
            // Start a new table
            inTable = true;
            tableContent = '<table class="conversation-table">';
          }

          // Process table row
          const cells = line.split('|').filter(cell => cell.trim() !== '');
          tableContent += '<tr>';
          cells.forEach(cell => {
            tableContent += `<td>${cell.trim()}</td>`;
          });
          tableContent += '</tr>';
        } else {
          if (inTable) {
            // End the table
            tableContent += '</table>';
            processedLines.push(tableContent);
            inTable = false;
            tableContent = '';
          }
          processedLines.push(line);
        }
      }

      // Close any open table
      if (inTable) {
        tableContent += '</table>';
        processedLines.push(tableContent);
      }

      formattedText = processedLines.join('<br>');
    }

    return formattedText;
  }

  // Update the conversation modal function
  function openConversationModal(item) {
    currentItemId = item.id;

    // Set title and user info
    document.getElementById('modal-title').textContent = "Conversation";
    document.getElementById('modal-username').textContent = `User: ${item.user}`;
    document.getElementById('modal-datetime').textContent = `Date: ${formatDateTime(item.datetime)}`;

    // Set conversation content
    const modalBody = document.getElementById('modal-body');
    modalBody.innerHTML = '';

    if (item.conversation && item.conversation.length > 0) {
      item.conversation.forEach(message => {
        const messageElement = document.createElement('div');
        messageElement.className = `conversation-item ${message.role}`;

        const formattedMessage = renderFormattedContent(message.message);

        messageElement.innerHTML = `
        <div class="conversation-bubble">
          <p class="conversation-role">${message.role === 'user' ? 'User' : 'Assistant'}</p>
          <div class="conversation-content">${formattedMessage}</div>
        </div>
      `;
        modalBody.appendChild(messageElement);
      });
    } else {
      modalBody.innerHTML = '<p>No conversation available</p>';
    }

    // Show modal with animation
    const modal = document.getElementById('feedback-modal');
    modal.classList.add('active');
  }

  // Update the suggestion modal function
  function openSuggestionModal(item) {
    currentItemId = item.id;

    // Set title and user info
    document.getElementById('modal-title').textContent = "Suggestions";
    document.getElementById('modal-username').textContent = `User: ${item.user}`;
    document.getElementById('modal-datetime').textContent = `Date: ${formatDateTime(item.datetime)}`;

    // Set suggestion content
    const modalBody = document.getElementById('modal-body');
    modalBody.innerHTML = '';

    const suggestionList = document.createElement('ul');
    suggestionList.className = 'suggestion-list';

    if (item.suggestions && item.suggestions.length > 0) {
      item.suggestions.forEach(suggestion => {
        const li = document.createElement('li');
        li.innerHTML = renderFormattedContent(suggestion);
        suggestionList.appendChild(li);
      });
    } else {
      const li = document.createElement('li');
      li.textContent = 'No suggestions available';
      suggestionList.appendChild(li);
    }

    modalBody.appendChild(suggestionList);

    // Show modal with animation
    const modal = document.getElementById('feedback-modal');
    modal.classList.add('active');
  }

  // Update the cypher query modal function
  function openCypherModal(item) {
    currentItemId = item.id;

    // Set title and user info
    document.getElementById('modal-title').textContent = "Cypher Query";
    document.getElementById('modal-username').textContent = `User: ${item.user}`;
    document.getElementById('modal-datetime').textContent = `Date: ${formatDateTime(item.datetime)}`;

    // Set cypher content
    const modalBody = document.getElementById('modal-body');
    modalBody.innerHTML = '';

    const cypherContainer = document.createElement('div');
    cypherContainer.className = 'cypher-container';

    if (item.cypherQueries && item.cypherQueries.length > 0) {
      item.cypherQueries.forEach(query => {
        const queryElement = document.createElement('div');
        queryElement.className = 'cypher-query';
        queryElement.innerHTML = renderFormattedContent(query);
        cypherContainer.appendChild(queryElement);
      });
    } else {
      const noQueryElement = document.createElement('div');
      noQueryElement.textContent = 'No Cypher queries available';
      cypherContainer.appendChild(noQueryElement);
    }

    modalBody.appendChild(cypherContainer);

    // Show modal with animation
    const modal = document.getElementById('feedback-modal');
    modal.classList.add('active');
  }

  // Load or initialize DOM elements
  document.addEventListener('DOMContentLoaded', function() {
    // Query for DOM elements
    const searchInput = document.getElementById('search-input');
    const schemaFilterButtons = document.querySelectorAll('#schema-filters .filter-btn');
    const positiveFilter = document.getElementById('positive-filter');
    const negativeFilter = document.getElementById('negative-filter');
    const hiddenFilter = document.getElementById('hidden-filter');
    const pageSizeButtons = document.querySelectorAll('.page-size-btn');
    const resultsCount = document.getElementById('results-count');
    const feedbackItems = document.getElementById('feedback-items');
    const noResults = document.getElementById('no-results');
    const connectionIndicator = document.getElementById('connection-indicator');
    const connectionText = document.getElementById('connection-text');

    // Modal elements
    const modal = document.getElementById('feedback-modal');
    const modalClose = document.getElementById('modal-close');

    // Setup event listeners
    searchInput.addEventListener('input', () => {
      searchQuery = searchInput.value.toLowerCase();
      applyFilters();
    });

    // Schema filter buttons (for filtering)
    schemaFilterButtons.forEach(button => {
      const schema = button.dataset.schema;
      button.addEventListener('click', () => filterBySchema(schema));
    });

    // Feedback filter event listeners
    positiveFilter.addEventListener('click', () => {
      if (activeFeedbackFilter === 'positive') {
        activeFeedbackFilter = null;
        positiveFilter.classList.remove('active');
      } else {
        activeFeedbackFilter = 'positive';
        positiveFilter.classList.add('active');
        negativeFilter.classList.remove('active');
      }
      applyFilters();
    });

    negativeFilter.addEventListener('click', () => {
      if (activeFeedbackFilter === 'negative') {
        activeFeedbackFilter = null;
        negativeFilter.classList.remove('active');
      } else {
        activeFeedbackFilter = 'negative';
        negativeFilter.classList.add('active');
        positiveFilter.classList.remove('active');
      }
      applyFilters();
    });

    // Toggle hidden items
    hiddenFilter.addEventListener('click', () => {
      showHidden = !showHidden;
      if (showHidden) {
        hiddenFilter.classList.add('active');
        hiddenFilter.textContent = 'Hide Archived';
        hiddenFilter.innerHTML = `
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="display: inline; margin-right: 4px;">
            <rect width="20" height="5" x="2" y="3" rx="1"></rect>
            <path d="M4 8v11a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8"></path>
            <path d="M10 12h4"></path>
          </svg>
          Hide Archived
        `;
      } else {
        hiddenFilter.classList.remove('active');
        hiddenFilter.innerHTML = `
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="display: inline; margin-right: 4px;">
            <rect width="20" height="5" x="2" y="3" rx="1"></rect>
            <path d="M4 8v11a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8"></path>
            <path d="M10 12h4"></path>
          </svg>
          Show Archived
        `;
      }
      applyFilters();
    });

    // Page size buttons
    pageSizeButtons.forEach(button => {
      button.addEventListener('click', () => {
        pageSizeButtons.forEach(btn => btn.classList.remove('active'));
        button.classList.add('active');
        pageSize = parseInt(button.dataset.size);
        renderItems();
      });
    });

    // Modal close button
    modalClose.addEventListener('click', () => {
      closeModal();
    });

    // Close modal when clicking outside
    modal.addEventListener('click', (e) => {
      if (e.target === modal) {
        closeModal();
      }
    });

    // Initialize with MongoDB connection
    connectToMongoDB();
  });

  // Function to open the modal with conversation content
  function openConversationModal(item) {
    currentItemId = item.id;

    // Set title and user info
    document.getElementById('modal-title').textContent = "Conversation";
    document.getElementById('modal-username').textContent = `User: ${item.user}`;
    document.getElementById('modal-datetime').textContent = `Date: ${formatDateTime(item.datetime)}`;

    // Set conversation content
    const modalBody = document.getElementById('modal-body');
    modalBody.innerHTML = '';

    if (item.conversation && item.conversation.length > 0) {
      item.conversation.forEach(message => {
        const messageElement = document.createElement('div');
        messageElement.className = `conversation-item ${message.role}`;

        const formattedMessage = renderFormattedContent(message.message);

        messageElement.innerHTML = `
        <div class="conversation-bubble">
          <p class="conversation-role">${message.role === 'user' ? 'User' : 'Assistant'}</p>
          <div class="conversation-content">${formattedMessage}</div>
        </div>
      `;
        modalBody.appendChild(messageElement);
      });
    } else {
      modalBody.innerHTML = '<p>No conversation available</p>';
    }

    // Show modal with animation
    const modal = document.getElementById('feedback-modal');
    modal.classList.add('active');
  }

  // Function to open the modal with suggestion content
  function openSuggestionModal(item) {
    currentItemId = item.id;

    // Set title and user info
    document.getElementById('modal-title').textContent = "Suggestion";
    document.getElementById('modal-username').textContent = `User: ${item.user}`;
    document.getElementById('modal-datetime').textContent = `Date: ${formatDateTime(item.datetime)}`;

    // Set suggestion content
    const modalBody = document.getElementById('modal-body');
    modalBody.innerHTML = '';

    const suggestionList = document.createElement('ul');
    suggestionList.className = 'suggestion-list';

    if (item.suggestions && item.suggestions.length > 0) {
      item.suggestions.forEach(suggestion => {
        const li = document.createElement('li');
        li.textContent = suggestion;
        suggestionList.appendChild(li);
      });
    } else {
      const li = document.createElement('li');
      li.textContent = 'No suggestions available';
      suggestionList.appendChild(li);
    }

    modalBody.appendChild(suggestionList);

    // Show modal with animation
    const modal = document.getElementById('feedback-modal');
    modal.classList.add('active');
  }

  // Function to open the modal with cypher query content
  function openCypherModal(item) {
    currentItemId = item.id;

    // Set title and user info
    document.getElementById('modal-title').textContent = "Cypher Query";
    document.getElementById('modal-username').textContent = `User: ${item.user}`;
    document.getElementById('modal-datetime').textContent = `Date: ${formatDateTime(item.datetime)}`;

    // Set cypher content
    const modalBody = document.getElementById('modal-body');
    modalBody.innerHTML = '';

    const cypherList = document.createElement('ul');
    cypherList.className = 'cypher-list';

    if (item.cypherQueries && item.cypherQueries.length > 0) {
      item.cypherQueries.forEach(query => {
        const li = document.createElement('li');
        li.textContent = query;
        cypherList.appendChild(li);
      });
    } else {
      const li = document.createElement('li');
      li.textContent = 'No Cypher queries available';
      cypherList.appendChild(li);
    }

    modalBody.appendChild(cypherList);

    // Show modal with animation
    const modal = document.getElementById('feedback-modal');
    modal.classList.add('active');
  }

  // Function to close the modal
  function closeModal() {
    const modal = document.getElementById('feedback-modal');
    modal.classList.remove('active');
    currentItemId = null;
  }

  // Updated MongoDB data conversion focusing on required fields
  function convertMongoDataToAppFormat(mongoData) {
    if (!mongoData || !Array.isArray(mongoData)) {
      console.error("Invalid MongoDB data:", mongoData);
      return [];
    }

    try {
      return mongoData.map(item => {
        try {
          console.log("Processing item:", item); // Add debugging to see the exact structure

          // Parse messages with better HTML handling
          let parsedMessages = parseMessages(item.messages || "[]");

          // Find first user message for question (but handle empty arrays)
          const firstUserMessage = parsedMessages.length > 0 ?
                  parsedMessages.find(msg => msg.role === 'user') : null;
          const question = firstUserMessage ? firstUserMessage.message : 'No question found';

          // Handle entitySuggesterData more robustly
          let suggestions = [];
          try {
            if (item.entitySuggesterData && item.entitySuggesterData !== "[]") {
              // Log for debugging
              console.log("Processing entitySuggesterData:", item.entitySuggesterData);

              // Try different parsing approaches
              if (typeof item.entitySuggesterData === 'string') {
                // Try basic replacement approach
                const cleanedData = item.entitySuggesterData
                        .replace(/=/g, ':')
                        .replace(/'/g, '"');

                try {
                  // Try parsing as JSON
                  const parsedData = JSON.parse(cleanedData);

                  if (Array.isArray(parsedData)) {
                    parsedData.forEach(entry => {
                      if (entry && entry.suggestion && entry.suggestion !== 'null') {
                        suggestions.push(entry.suggestion);
                      } else if (entry && entry.text && entry.text !== 'null') {
                        suggestions.push(entry.text);
                      } else if (entry && typeof entry === 'string') {
                        suggestions.push(entry);
                      }
                    });
                  }
                } catch (jsonError) {
                  console.warn("Error parsing entitySuggesterData as JSON", jsonError);

                  // Use regex as fallback
                  const suggestionMatches = item.entitySuggesterData.match(/suggestion=([^,}]+)/g);
                  if (suggestionMatches) {
                    suggestionMatches.forEach(match => {
                      const value = match.replace('suggestion=', '').trim();
                      if (value && value !== 'null') {
                        suggestions.push(value);
                      }
                    });
                  }
                }
              }
            }
          } catch (suggErr) {
            console.warn("Error processing suggestions:", suggErr);
          }

          // Handle sql_query more safely
          let cypherQueries = [];
          if (item.sql_query) {
            // Ensure it's not null
            if (typeof item.sql_query === 'string' && item.sql_query.trim() !== '') {
              cypherQueries = [item.sql_query];
            }
          } else {
            // Try to extract query from agentHistoryFilteredData as fallback
            try {
              if (item.agentHistoryFilteredData && item.agentHistoryFilteredData.includes('content=MATCH')) {
                const match = item.agentHistoryFilteredData.match(/content=(MATCH[^}]+)/);
                if (match && match[1]) {
                  cypherQueries = [match[1].trim()];
                }
              }
            } catch (queryErr) {
              console.warn("Error extracting query from history:", queryErr);
            }
          }

          // Extract timestamp with more robust handling
          let timestamp;
          if (item.timestamp) {
            timestamp = typeof item.timestamp === 'number' ?
                    item.timestamp :
                    (typeof item.timestamp === 'string' ? parseInt(item.timestamp) : null);
          } else if (item.RDate && item.RDate.$date) {
            timestamp = new Date(item.RDate.$date).getTime();
          } else {
            timestamp = Date.now();
          }

          // Format date
          const date = new Date(timestamp);
          const formattedDate = isNaN(date.getTime()) ? 'Invalid date' :
                  date.toLocaleDateString() + ' ' + date.toLocaleTimeString();

          // Extract ID with improved handling
          const id = item._id?.$oid ||
                  (typeof item._id === 'string' ? item._id : null) ||
                  item.uuid ||
                  `temp-${Date.now()}-${Math.random().toString(36).substring(2, 9)}`;

          // Check for data presence
          const hasAgentHistoryData = item.agentHistoryFilteredData &&
                  item.agentHistoryFilteredData !== "[]" &&
                  item.agentHistoryFilteredData.length > 2;

          const hasContractIds = item.contract_ids &&
                  item.contract_ids !== "[]" &&
                  item.contract_ids.length > 2;

          const hasDocumentIds = item.document_ids &&
                  item.document_ids !== "[]" &&
                  item.document_ids.length > 2;

          const hasEntitySuggesterData = item.entitySuggesterData &&
                  item.entitySuggesterData !== "[]" &&
                  item.entitySuggesterData.length > 2;

          return {
            id: id,
            schema: item.schema || '', // This field might not be present in new data
            question: question,
            conversation: parsedMessages,
            suggestions: suggestions,
            cypherQueries: cypherQueries,
            feedback: item.feedback || null,
            hidden: item.hidden || false,
            user: item.userName || 'Unknown',
            datetime: formattedDate,
            timestamp: timestamp,
            // Add new data fields
            agentHistoryFilteredData: item.agentHistoryFilteredData || "[]",
            contractIds: item.contract_ids || "[]",
            documentIds: item.document_ids || "[]",
            entitySuggesterData: item.entitySuggesterData || "[]",
            // Add flags for button enabling
            hasAgentHistoryData: hasAgentHistoryData,
            hasContractIds: hasContractIds,
            hasDocumentIds: hasDocumentIds,
            hasEntitySuggesterData: hasEntitySuggesterData
          };
        } catch (itemError) {
          console.error("Error converting item:", itemError, item);
          return null;
        }
      }).filter(Boolean); // Remove any null items
    } catch (error) {
      console.error("Error converting MongoDB data:", error);
      return [];
    }
  }

  // Memory-efficient message parsing
  function parseMessages(messagesString) {
    try {
      // Add detailed debugging
      console.log("Parsing messages:", messagesString);

      // Handle null/undefined
      if (!messagesString) {
        console.warn('Messages is null or undefined');
        return [
          { role: 'user', message: 'No messages available' }
        ];
      }

      // If it's not a string, return default message
      if (typeof messagesString !== 'string') {
        console.warn('Messages is not a string:', messagesString);
        return [
          { role: 'user', message: 'Message parsing error' },
          { role: 'assistant', message: 'Unable to parse messages' }
        ];
      }

      // Handle new format with role=user, content=...
      if (messagesString.includes('role=') && messagesString.includes('content=')) {
        try {
          // Clean up the string to make it more parseable
          let cleanedString = messagesString
                  .replace(/^\[|\]$/g, '') // Remove outer brackets
                  .replace(/\}\s*,\s*\{/g, '}|||{'); // Replace comma between objects with separator

          // Split by our separator
          const messageParts = cleanedString.split('|||');

          return messageParts.map(part => {
            // Extract role
            const roleMatch = part.match(/role=([^,}]+)/);
            const role = roleMatch ? roleMatch[1].trim() : 'unknown';

            // Extract content - capture everything after content= until the end or next field
            const contentMatch = part.match(/content=(.*?)(?=\s*,\s*\w+=|\s*\}|\s*$)/s);
            let message = contentMatch ? contentMatch[1].trim() : 'No content';

            // If message starts with a quotation mark but doesn't end with one, add it
            if (message.startsWith('"') && !message.endsWith('"') && !message.endsWith('"}')) {
              message += '"';
            }

            // Clean up any remaining braces or quotes
            message = message.replace(/^\{|\}$/g, '').trim();
            message = message.replace(/^"|"$/g, '').trim();

            return { role, message };
          });
        } catch (formatError) {
          console.error("Error parsing new message format:", formatError);
        }
      }

      // Try JSON parsing
      try {
        // First try direct JSON parse
        const parsedJson = JSON.parse(messagesString);
        if (Array.isArray(parsedJson)) {
          return parsedJson.map(msg => ({
            role: msg.role || 'unknown',
            message: msg.content || 'No content'
          }));
        }
      } catch (jsonError) {
        // Continue to other approaches
        console.warn("JSON parsing failed:", jsonError.message);
      }

      // Try with replacements
      try {
        // Replace = with : to make it valid JSON-like
        let jsonLikeString = messagesString
                .replace(/([a-zA-Z]+)=/g, '"$1":')
                .replace(/'/g, '"');

        const parsedJson = JSON.parse(jsonLikeString);
        if (Array.isArray(parsedJson)) {
          return parsedJson.map(msg => ({
            role: msg.role || 'unknown',
            message: msg.content || 'No content'
          }));
        }
      } catch (jsonError2) {
        console.warn('Failed with replacements too:', jsonError2.message);
      }

      // Try regex approach
      try {
        const matches = messagesString.match(/\{role=(.*?), content=(.*?)(\},|\}$)/gs);
        if (matches && matches.length > 0) {
          return matches.map(match => {
            const roleMatch = match.match(/role=(.*?),/);
            const contentMatch = match.match(/content=(.*?)(\},|\}$)/s);

            return {
              role: roleMatch ? roleMatch[1].trim() : 'unknown',
              message: contentMatch ? contentMatch[1].trim() : 'Error parsing message'
            };
          });
        }
      } catch (regexError) {
        console.warn('Regex parsing failed:', regexError.message);
      }

      // Last resort
      console.warn("Using fallback parsing for:", messagesString.substring(0, 50) + "...");
      return [
        { role: 'user', message: 'Error parsing message' },
        { role: 'assistant', message: 'Error parsing message' }
      ];
    } catch (error) {
      console.error("Critical error parsing messages:", error);
      return [
        { role: 'user', message: 'Error parsing message' },
        { role: 'assistant', message: 'Error parsing message' }
      ];
    }
  }

  // Connect to MongoDB via API with pagination
  async function connectToMongoDB(page = 0) {
    try {
      // Show connecting status
      connectionIndicator.classList.remove('connected');
      connectionIndicator.classList.remove('disconnected');
      connectionText.textContent = `Connecting to MongoDB (page ${page + 1})...`;

      // Clear existing data
      data = [];
      filteredData = [];

      // Fetch data from our backend API with pagination
      const response = await fetch(`${API_BASE_URL}/conversations?page=${page}&limit=${pageSize}`);

      if (!response.ok) {
        throw new Error(`API responded with status: ${response.status}`);
      }

      const result = await response.json();
      console.log("API response:", result);

      let mongoData;
      if (result.data) {
        mongoData = result.data;

        // Update pagination info
        currentPage = result.pagination.page;
        totalPages = result.pagination.totalPages;
      } else {
        // Handle old API format
        mongoData = result;
        currentPage = 0;
        totalPages = 1;
      }

      // Update connection status
      connectionIndicator.classList.add('connected');
      connectionText.textContent = `Connected to MongoDB - ${mongoData.length} records loaded`;

      if (result.pagination) {
        connectionText.textContent += ` (Page ${currentPage + 1} of ${totalPages} - Total: ${result.pagination.totalCount})`;
      }

      // Convert and store data
      data = convertMongoDataToAppFormat(mongoData);
      console.log("Converted data:", data);

      filteredData = [...data.filter(item => !item.hidden)];

      // In connectToMongoDB function, add after data conversion:
      console.log("API response received:", result);
      console.log("Converted data length:", data.length);
      console.log("First item:", data[0]);

      // Initialize tabs
      initializeTabs(totalPages);

      // Render items
      renderItems();

    } catch (error) {
      console.error('Error connecting to MongoDB:', error);
      connectionIndicator.classList.add('disconnected');
      connectionText.textContent = 'Failed to connect to MongoDB: ' + error.message;

      // For development/testing - use sample data in case of error
      if (confirm('Connection to API failed. Use sample data instead?')) {
        // Create some sample data
        const sampleData = [
          {
            id: "sample1",
            schema: "Mesai",
            question: "What are my work hours this week?",
            conversation: [
              { role: "user", message: "What are my work hours this week?" },
              { role: "assistant", message: "Your work hours for this week are:\nMonday: 9 AM - 5 PM\nTuesday: 9 AM - 5 PM\nWednesday: 10 AM - 6 PM\nThursday: 9 AM - 5 PM\nFriday: 9 AM - 4 PM" }
            ],
            suggestions: [
              "You might want to check your overtime hours for last week",
              "Would you like to request time off?",
              "Do you need to see your vacation balance?"
            ],
            cypherQueries: [
              "MATCH (e:Employee {id: '12345'})-[:HAS_SCHEDULE]->(s:Schedule) WHERE s.week = '2023-W42' RETURN s",
              "MATCH (e:Employee {id: '12345'})-[:WORKED]->(h:Hours) WHERE h.date >= '2023-10-16' RETURN h"
            ],
            feedback: "positive",
            hidden: false,
            user: "testuser1",
            datetime: "2023-10-20 14:32:45"
          },
          {
            id: "sample2",
            schema: "Mukavele",
            question: "When does my contract expire?",
            conversation: [
              { role: "user", message: "When does my contract expire?" },
              { role: "assistant", message: "Your current contract expires on December 31, 2023. Would you like information about the renewal process?" }
            ],
            suggestions: [
              "You might want to review your contract terms",
              "Would you like to schedule a meeting with HR about renewal?",
              "Do you need information about contract extensions?"
            ],
            cypherQueries: [
              "MATCH (e:Employee {id: '12345'})-[:HAS_CONTRACT]->(c:Contract) RETURN c.expiryDate",
              "MATCH (c:Contract)-[:HAS_TERMS]->(t:Terms) WHERE c.employeeId = '12345' RETURN t"
            ],
            feedback: "negative",
            hidden: false,
            user: "testuser2",
            datetime: "2023-10-19 10:15:30"
          },
          {
            id: "sample3",
            schema: "Genel",
            question: "How do I request vacation time?",
            conversation: [
              { role: "user", message: "How do I request vacation time?" },
              { role: "assistant", message: "To request vacation time, you need to:\n1. Log into the employee portal\n2. Go to 'Time Off' section\n3. Click 'Request Time Off'\n4. Select the dates and type of leave\n5. Submit for approval" }
            ],
            suggestions: [
              "You currently have 15 vacation days available",
              "Would you like to see the company holiday calendar?",
              "Do you need information about sick leave policy?"
            ],
            cypherQueries: [
              "MATCH (e:Employee {id: '12345'})-[:HAS_BENEFITS]->(b:Benefits) RETURN b.vacationDays",
              "MATCH (p:Policy {type: 'vacation'})-[:APPLIES_TO]->(d:Department {id: '54321'}) RETURN p"
            ],
            feedback: null,
            hidden: true,
            user: "testuser3",
            datetime: "2023-10-18 09:45:12"
          }
        ];

        data = sampleData;
        filteredData = [...data.filter(item => !item.hidden)];

        // Mock pagination for sample data
        currentPage = 0;
        totalPages = 1;
        initializeTabs(totalPages);

        renderItems();
      }
    }
  }

  // Initialize tab navigation
  function initializeTabs(totalPages) {
    const tabsList = document.getElementById('tabs-list');
    const prevTabBtn = document.getElementById('prev-tab-btn');
    const nextTabBtn = document.getElementById('next-tab-btn');

    if (!tabsList || !prevTabBtn || !nextTabBtn) return;

    // Clear existing tabs
    tabsList.innerHTML = '';

    // Create tabs
    for (let i = 0; i < totalPages; i++) {
      const tab = document.createElement('button');
      tab.className = `pagination-btn${currentPage === i ? ' active' : ''}`;
      tab.textContent = `Page ${i + 1}`;
      tab.dataset.page = i;

      tab.addEventListener('click', () => {
        if (currentPage !== i) {
          loadPage(i);
        }
      });

      tabsList.appendChild(tab);
    }

    // Update tab visibility based on current page
    updateTabsVisibility();

    // Update navigation buttons
    prevTabBtn.disabled = currentPage === 0;
    nextTabBtn.disabled = currentPage === totalPages - 1;

    // Add event listeners to navigation buttons
    prevTabBtn.addEventListener('click', () => {
      if (currentPage > 0) {
        loadPage(currentPage - 1);
      }
    });

    nextTabBtn.addEventListener('click', () => {
      if (currentPage < totalPages - 1) {
        loadPage(currentPage + 1);
      }
    });
  }

  // Load specific page
  async function loadPage(page) {
    // Show loading state
    connectionText.textContent = `Loading page ${page + 1}...`;

    try {
      // Fetch data for specific page
      const response = await fetch(`${API_BASE_URL}/conversations?page=${page}&limit=${pageSize}`);

      if (!response.ok) {
        throw new Error(`API responded with status: ${response.status}`);
      }

      const result = await response.json();
      const mongoData = result.data;

      // Update current page
      currentPage = page;

      // Convert and store data
      data = convertMongoDataToAppFormat(mongoData);
      filteredData = [...data.filter(item => !item.hidden)];

      // Update tabs
      const tabButtons = document.querySelectorAll('.pagination-btn');
      tabButtons.forEach(tab => {
        const tabPage = parseInt(tab.dataset.page);
        tab.classList.toggle('active', tabPage === currentPage);
      });

      // Update tab visibility
      updateTabsVisibility();

      // Update navigation buttons
      document.getElementById('prev-tab-btn').disabled = currentPage === 0;
      document.getElementById('next-tab-btn').disabled = currentPage === totalPages - 1;

      // Update connection status
      connectionText.textContent = `Page ${currentPage + 1} of ${totalPages} - Total records: ${result.pagination.totalCount}`;

      // Render items
      renderItems();

    } catch (error) {
      console.error('Error loading page:', error);
      connectionText.textContent = `Failed to load page ${page + 1}: ${error.message}`;
    }
  }

  // Update which tabs are visible
  function updateTabsVisibility() {
    const tabButtons = document.querySelectorAll('.pagination-btn');

    // Calculate start and end indexes for visible tabs
    let startIndex = Math.max(0, currentPage - Math.floor(visibleTabCount / 2));
    let endIndex = Math.min(totalPages - 1, startIndex + visibleTabCount - 1);

    // Adjust start index if needed
    if (endIndex - startIndex + 1 < visibleTabCount) {
      startIndex = Math.max(0, endIndex - visibleTabCount + 1);
    }

    // Show/hide tabs based on calculated range
    tabButtons.forEach((tab, index) => {
      tab.style.display = (index >= startIndex && index <= endIndex) ? 'block' : 'none';
    });
  }

  // Filter by schema
  function filterBySchema(schema) {
    const button = document.querySelector(`.filter-btn[data-schema="${schema}"]`);

    if (!button) return;

    if (activeSchema === schema) {
      activeSchema = null;
      button.classList.remove('active');
    } else {
      // Remove active class from all schema buttons
      document.querySelectorAll('.filter-btn[data-schema]').forEach(btn => {
        btn.classList.remove('active');
      });

      activeSchema = schema;
      button.classList.add('active');
    }

    applyFilters();
  }

  // Apply all filters
  function applyFilters() {
    let filtered = [...data];

    // Apply schema filter if active
    if (activeSchema) {
      filtered = filtered.filter(item => item.schema === activeSchema);
    }

    // Apply feedback filter if active
    if (activeFeedbackFilter) {
      filtered = filtered.filter(item => item.feedback === activeFeedbackFilter);
    }

    // Apply hidden filter
    if (!showHidden) {
      filtered = filtered.filter(item => !item.hidden);
    }

    // Apply search query
    if (searchQuery) {
      filtered = filtered.filter(item =>
              (item.question && item.question.toLowerCase().includes(searchQuery)) ||
              (item.conversation && item.conversation.some(msg =>
                      msg.message.toLowerCase().includes(searchQuery)
              )) ||
              (item.user && item.user.toLowerCase().includes(searchQuery))
      );
    }

    filteredData = filtered;
    renderItems();
  }

  // Render feedback items with the updated design
  function renderItems() {
    const feedbackItems = document.getElementById('feedback-items');
    const noResults = document.getElementById('no-results');
    const resultsCount = document.getElementById('results-count');

    console.log("Rendering items, filtered data length:", filteredData.length);

    if (!feedbackItems || !noResults || !resultsCount) return;

    // Update results count
    resultsCount.textContent = `Showing ${Math.min(pageSize, filteredData.length)} of ${filteredData.length} results`;

    // Clear items container
    feedbackItems.innerHTML = '';

    // Show or hide no results message
    if (filteredData.length === 0) {
      noResults.classList.remove('hidden');
    } else {
      noResults.classList.add('hidden');

      // Render items
      filteredData.slice(0, pageSize).forEach((item, index) => {
        // Create main feedback item container
        const itemElement = document.createElement('div');
        itemElement.className = 'feedback-item';
        itemElement.dataset.id = item.id;

        // Create schema buttons column
        const schemaButtons = document.createElement('div');
        schemaButtons.className = 'schema-buttons';

        // Add schema buttons
        schemaList.forEach(schema => {
          const button = document.createElement('button');
          button.className = `schema-btn${item.schema === schema ? ' active' : ''}`;
          button.textContent = schema;
          button.dataset.schema = schema;

          button.addEventListener('click', (e) => {
            e.stopPropagation(); // Don't open the modal when clicking schema buttons
            setSchema(item.id, schema);
          });

          schemaButtons.appendChild(button);
        });

        // Create content area with user info and buttons
        const contentArea = document.createElement('div');
        contentArea.className = 'feedback-content';

        // Add user info section
        const userInfo = document.createElement('div');
        userInfo.className = 'feedback-user-info';
        userInfo.innerHTML = `
          <span class="user-name">User: ${item.user}</span>
          <span class="datetime">${formatDateTime(item.datetime)}</span>
        `;
        contentArea.appendChild(userInfo);

        // Create buttons container
        const buttonsContainer = document.createElement('div');
        buttonsContainer.className = 'feedback-buttons';

        // Create large conversation button
        const conversationBtn = document.createElement('button');
        conversationBtn.className = 'conversation-btn';
        conversationBtn.textContent = item.question;
        conversationBtn.addEventListener('click', () => {
          openConversationModal(item);
        });

        // Create container for small buttons
        const smallButtons = document.createElement('div');
        smallButtons.className = 'small-buttons';

        // Create suggestion button
        const suggestionBtn = document.createElement('button');
        suggestionBtn.className = 'suggestion-btn';
        suggestionBtn.textContent = 'Suggestion';
        suggestionBtn.addEventListener('click', () => {
          openSuggestionModal(item);
        });

        // Create cypher button
        const cypherBtn = document.createElement('button');
        cypherBtn.className = 'cypher-btn';
        cypherBtn.textContent = 'Cypher Query';
        cypherBtn.addEventListener('click', () => {
          openCypherModal(item);
        });

        // Add small buttons to container
        smallButtons.appendChild(suggestionBtn);
        smallButtons.appendChild(cypherBtn);

        // Add buttons to container
        buttonsContainer.appendChild(conversationBtn);
        buttonsContainer.appendChild(smallButtons);

        // Add buttons container to content area
        contentArea.appendChild(buttonsContainer);

        // Create additional data buttons container
        const additionalDataButtons = document.createElement('div');
        additionalDataButtons.className = 'additional-data-buttons';

        // Create agent history button
        const agentHistoryBtn = document.createElement('button');
        agentHistoryBtn.className = 'data-btn agent-history-btn';
        agentHistoryBtn.disabled = !item.hasAgentHistoryData;
        agentHistoryBtn.innerHTML = `
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M12 8c-2.8 0-5 2.2-5 5s2.2 5 5 5 5-2.2 5-5-2.2-5-5-5Z"></path>
            <path d="M3 12c0-5.5 5.9-10 9-10"></path>
            <path d="M15 2v6h6"></path>
            <path d="M21 12c0 5.5-5.9 10-9 10"></path>
            <path d="M9 22v-6H3"></path>
          </svg>
          Agent History
        `;
        agentHistoryBtn.addEventListener('click', (e) => {
          e.stopPropagation();
          if (item.hasAgentHistoryData) {
            openDataPopup('Agent History', item.agentHistoryFilteredData);
          }
        });

        // Create contract IDs button
        const contractIdsBtn = document.createElement('button');
        contractIdsBtn.className = 'data-btn contract-ids-btn';
        contractIdsBtn.disabled = !item.hasContractIds;
        contractIdsBtn.innerHTML = `
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M14 3v4a1 1 0 0 0 1 1h4"></path>
            <path d="M17 21H7a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h7l5 5v11a2 2 0 0 1-2 2Z"></path>
            <path d="M9 9h1"></path>
            <path d="M9 13h6"></path>
            <path d="M9 17h6"></path>
          </svg>
          Contract IDs
        `;
        contractIdsBtn.addEventListener('click', (e) => {
          e.stopPropagation();
          if (item.hasContractIds) {
            openDataPopup('Contract IDs', item.contractIds);
          }
        });

        // Create document IDs button
        const documentIdsBtn = document.createElement('button');
        documentIdsBtn.className = 'data-btn document-ids-btn';
        documentIdsBtn.disabled = !item.hasDocumentIds;
        documentIdsBtn.innerHTML = `
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
            <polyline points="14 2 14 8 20 8"></polyline>
            <line x1="16" y1="13" x2="8" y2="13"></line>
            <line x1="16" y1="17" x2="8" y2="17"></line>
            <polyline points="10 9 9 9 8 9"></polyline>
          </svg>
          Document IDs
        `;
        documentIdsBtn.addEventListener('click', (e) => {
          e.stopPropagation();
          if (item.hasDocumentIds) {
            openDataPopup('Document IDs', item.documentIds);
          }
        });

        // Create entity suggester button
        const entitySuggesterBtn = document.createElement('button');
        entitySuggesterBtn.className = 'data-btn entity-suggester-btn';
        entitySuggesterBtn.disabled = !item.hasEntitySuggesterData;
        entitySuggesterBtn.innerHTML = `
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"></polygon>
          </svg>
          Entity Data
        `;
        entitySuggesterBtn.addEventListener('click', (e) => {
          e.stopPropagation();
          if (item.hasEntitySuggesterData) {
            openDataPopup('Entity Suggester Data', item.entitySuggesterData);
          }
        });

        // Add buttons to container
        additionalDataButtons.appendChild(agentHistoryBtn);
        additionalDataButtons.appendChild(contractIdsBtn);
        additionalDataButtons.appendChild(documentIdsBtn);
        additionalDataButtons.appendChild(entitySuggesterBtn);

        // Add additional data buttons to the content area
        contentArea.appendChild(additionalDataButtons);

        // Create the actions column
        const actions = document.createElement('div');
        actions.className = 'feedback-actions';

        // Positive button (thumbs up)
        const positiveBtn = document.createElement('button');
        positiveBtn.className = `action-btn positive${item.feedback === 'positive' ? ' active' : ''}`;
        positiveBtn.dataset.action = 'positive';
        positiveBtn.innerHTML = `
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M7 10v12"></path>
            <path d="M15 5.88 14 10h5.83a2 2 0 0 1 1.92 2.56l-2.33 8A2 2 0 0 1 17.5 22H4a2 2 0 0 1-2-2v-8a2 2 0 0 1 2-2h2.76a2 2 0 0 0 1.79-1.11L12 2h0a3.13 3.13 0 0 1 3 3.88Z"></path>
          </svg>
        `;

        positiveBtn.addEventListener('click', (e) => {
          e.stopPropagation(); // Don't open the modal
          handlePositiveFeedback(item.id);
        });

        // Archive button (now in middle position)
        const archiveBtn = document.createElement('button');
        archiveBtn.className = `action-btn archive${item.hidden ? ' active' : ''}`;
        archiveBtn.dataset.action = 'archive';
        archiveBtn.innerHTML = `
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <rect width="20" height="5" x="2" y="3" rx="1"></rect>
            <path d="M4 8v11a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8"></path>
            <path d="M10 12h4"></path>
          </svg>
        `;

        archiveBtn.addEventListener('click', (e) => {
          e.stopPropagation(); // Don't open the modal
          handleToggleHidden(item.id);
        });

        // Negative button (thumbs down) - now last
        const negativeBtn = document.createElement('button');
        negativeBtn.className = `action-btn negative${item.feedback === 'negative' ? ' active' : ''}`;
        negativeBtn.dataset.action = 'negative';
        negativeBtn.innerHTML = `
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M17 14V2"></path>
            <path d="M9 18.12 10 14H4.17a2 2 0 0 1-1.92-2.56l2.33-8A2 2 0 0 1 6.5 2H20a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2h-2.76a2 2 0 0 0-1.79 1.11L12 22h0a3.13 3.13 0 0 1-3-3.88Z"></path>
          </svg>
        `;

        negativeBtn.addEventListener('click', (e) => {
          e.stopPropagation(); // Don't open the modal
          handleNegativeFeedback(item.id);
        });

        // Add action buttons to actions container in the new order
        actions.appendChild(positiveBtn);
        actions.appendChild(archiveBtn);
        actions.appendChild(negativeBtn);

        // Add all parts to the item
        itemElement.appendChild(schemaButtons);
        itemElement.appendChild(contentArea);
        itemElement.appendChild(actions);

        // Add to the container
        feedbackItems.appendChild(itemElement);
      });
    }
  }

  // Create a popup for displaying additional data
  function openDataPopup(title, data) {
    // Check if a popup already exists and remove it
    const existingPopup = document.getElementById('data-popup');
    if (existingPopup) {
      existingPopup.remove();
    }

    // Create popup container
    const popup = document.createElement('div');
    popup.id = 'data-popup';
    popup.className = 'data-popup';
    popup.setAttribute('role', 'dialog');
    popup.setAttribute('aria-labelledby', 'popup-title');
    popup.setAttribute('aria-modal', 'true');

    // Create popup content
    const popupContent = document.createElement('div');
    popupContent.className = 'popup-content';

    // Create header
    const popupHeader = document.createElement('div');
    popupHeader.className = 'popup-header';

    // Create title
    const popupTitle = document.createElement('h3');
    popupTitle.id = 'popup-title';
    popupTitle.textContent = title;
    popupHeader.appendChild(popupTitle);

    // Create button container for header
    const headerButtons = document.createElement('div');
    headerButtons.className = 'popup-header-buttons';

    // Create copy button
    const copyButton = document.createElement('button');
    copyButton.className = 'popup-copy';
    copyButton.title = 'Copy to clipboard';
    copyButton.innerHTML = `
    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
      <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
    </svg>
  `;
    copyButton.addEventListener('click', () => {
      let textToCopy = typeof data === 'object' ? JSON.stringify(data, null, 2) : data;
      navigator.clipboard.writeText(textToCopy)
              .then(() => {
                copyButton.classList.add('success');
                setTimeout(() => copyButton.classList.remove('success'), 1500);
              })
              .catch(err => console.error('Failed to copy: ', err));
    });
    headerButtons.appendChild(copyButton);

    // Create close button
    const closeButton = document.createElement('button');
    closeButton.className = 'popup-close';
    closeButton.title = 'Close';
    closeButton.setAttribute('aria-label', 'Close');
    closeButton.innerHTML = `
    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <line x1="18" y1="6" x2="6" y2="18"></line>
      <line x1="6" y1="6" x2="18" y2="18"></line>
    </svg>
  `;
    closeButton.addEventListener('click', () => closePopup(popup));
    headerButtons.appendChild(closeButton);

    popupHeader.appendChild(headerButtons);
    popupContent.appendChild(popupHeader);

    // Create body
    const popupBody = document.createElement('div');
    popupBody.className = 'popup-body';

    // Format and add the data
    let formattedData;
    try {
      // Handle if data is already an object
      if (typeof data === 'object' && data !== null) {
        formattedData = `<pre>${JSON.stringify(data, null, 2)}</pre>`;
      }
      // Try to parse JSON if it's a string
      else if (typeof data === 'string') {
        try {
          const parsedData = JSON.parse(data);
          formattedData = `<pre>${JSON.stringify(parsedData, null, 2)}</pre>`;
        } catch {
          // If not valid JSON, display as formatted text
          formattedData = `<pre>${data}</pre>`;
        }
      } else {
        formattedData = `<pre>${String(data)}</pre>`;
      }
    } catch (e) {
      formattedData = `<pre>Error displaying data: ${e.message}</pre>`;
    }

    popupBody.innerHTML = formattedData;
    popupContent.appendChild(popupBody);

    // Add content to popup
    popup.appendChild(popupContent);

    // Add popup to body
    document.body.appendChild(popup);

    // Trap focus in modal for accessibility
    const focusableElements = popup.querySelectorAll('button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])');
    const firstElement = focusableElements[0];
    if (firstElement) firstElement.focus();

    // Animate the popup
    setTimeout(() => popup.classList.add('active'), 10);

    // Close popup function
    function closePopup(element) {
      element.classList.remove('active');
      setTimeout(() => element.remove(), 300);
    }

    // Add click outside to close
    popup.addEventListener('click', (e) => {
      if (e.target === popup) closePopup(popup);
    });

    // Add escape key to close
    const escapeHandler = (e) => {
      if (e.key === 'Escape') {
        closePopup(popup);
        document.removeEventListener('keydown', escapeHandler);
      }
    };
    document.addEventListener('keydown', escapeHandler);
  }

  // Handle positive feedback
  async function handlePositiveFeedback(id) {
    const item = data.find(item => item.id === id);
    if (!item) return;

    // If already positive, remove feedback
    const newFeedback = item.feedback === 'positive' ? null : 'positive';

    // Update data locally first
    data = data.map(item => {
      if (item.id === id) {
        return { ...item, feedback: newFeedback };
      }
      return item;
    });

    // Update MongoDB via API
    try {
      const response = await fetch(`${API_BASE_URL}/conversations/${id}/feedback`, {
        method: 'PATCH',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ feedback: newFeedback })
      });

      if (!response.ok) {
        console.error('Error updating feedback:', await response.text());
      }
    } catch (error) {
      console.error('Failed to update feedback:', error);
    }

    // Apply filters to update UI
    applyFilters();
  }

  // Handle negative feedback
  async function handleNegativeFeedback(id) {
    const item = data.find(item => item.id === id);
    if (!item) return;

    // If already negative, remove feedback
    const newFeedback = item.feedback === 'negative' ? null : 'negative';

    // Update data locally first
    data = data.map(item => {
      if (item.id === id) {
        return { ...item, feedback: newFeedback };
      }
      return item;
    });

    // Update MongoDB via API
    try {
      const response = await fetch(`${API_BASE_URL}/conversations/${id}/feedback`, {
        method: 'PATCH',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ feedback: newFeedback })
      });

      if (!response.ok) {
        console.error('Error updating feedback:', await response.text());
      }
    } catch (error) {
      console.error('Failed to update feedback:', error);
    }

    // Apply filters to update UI
    applyFilters();
  }

  // Handle toggle hidden
  async function handleToggleHidden(id) {
    const item = data.find(item => item.id === id);
    if (!item) return;

    // Toggle hidden state
    const newHiddenState = !item.hidden;

    // Update data locally first
    data = data.map(item => {
      if (item.id === id) {
        return { ...item, hidden: newHiddenState };
      }
      return item;
    });

    // Update MongoDB via API
    try {
      const response = await fetch(`${API_BASE_URL}/conversations/${id}/archive`, {
        method: 'PATCH',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ hidden: newHiddenState })
      });

      if (!response.ok) {
        console.error('Error updating archive status:', await response.text());
      }
    } catch (error) {
      console.error('Failed to update archive status:', error);
    }

    // Apply filters to update UI
    applyFilters();
  }

  // Set schema for an item
  async function setSchema(id, schema) {
    const item = data.find(item => item.id === id);
    if (!item) return;

    // Update schema locally first
    const oldSchema = item.schema;
    item.schema = schema;

    // Update schema buttons in this item
    const itemElement = document.querySelector(`.feedback-item[data-id="${id}"]`);
    if (itemElement) {
      const schemaButtons = itemElement.querySelectorAll('.schema-btn');
      schemaButtons.forEach(button => {
        const buttonSchema = button.dataset.schema;
        button.classList.toggle('active', buttonSchema === schema);
      });
    }

    // Update MongoDB via API
    try {
      const response = await fetch(`${API_BASE_URL}/conversations/${id}/schema`, {
        method: 'PATCH',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ schema })
      });

      if (!response.ok) {
        console.error('Error updating schema:', await response.text());
        // Revert to old schema if update failed
        item.schema = oldSchema;
        if (itemElement) {
          const schemaButtons = itemElement.querySelectorAll('.schema-btn');
          schemaButtons.forEach(button => {
            const buttonSchema = button.dataset.schema;
            button.classList.toggle('active', buttonSchema === oldSchema);
          });
        }
        alert('Failed to update schema on server. Please try again.');
        return;
      }

      // Apply filters to update UI if needed
      if (activeSchema) {
        applyFilters();
      }
    } catch (error) {
      console.error('Failed to update schema:', error);
      // Revert to old schema if update failed
      item.schema = oldSchema;
      if (itemElement) {
        const schemaButtons = itemElement.querySelectorAll('.schema-btn');
        schemaButtons.forEach(button => {
          const buttonSchema = button.dataset.schema;
          button.classList.toggle('active', buttonSchema === oldSchema);
        });
      }
      alert('Failed to update schema: ' + error.message);
    }
  }
</script>

<!-- Include fix scripts -->
<script src="comprehensive-fix.js"></script>
<script src="comprehensive-fix-2.js"></script>
<script src="ui-debug-tool.js"></script>
<script src="continuous-loading-fix.js"></script>
<script src="feedback-system-fixes.js"></script>
<script src="feedback-system-fixes-2.js"></script>
<script src="pagination-fix.js"></script>
<script src="similarity-fix.js"></script>
<script src="debug-mode.js"></script>
</body>
</html>